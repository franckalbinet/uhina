# Fastai BW data augmentation


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Runpod setup

``` python
# setting up pod and pip install uhina
# accessing a pod terminal

# 1. To get access to the pod ip adress: runpodctl get pod -a
# 2. ssh into the pod: ssh root@<ip-address> -p 58871 -i ~/.ssh/id_ed25519


# runpodctl send uhina 
# pip install -e '.[dev]'

# git clone https://github.com/franckalbinet/uhina.git
# pip install uhina
# runpodctl send im-bw 
# runpodctl send ossl-tfm.csv
```

## Loading data

``` python
import pandas as pd
from pathlib import Path
import fastcore.all as fc

from fastai.data.all import *
from fastai.vision.all import *
from multiprocessing import cpu_count
from uhina.augment import Quantize

import warnings
warnings.filterwarnings('ignore')
```

``` python
ossl_source = '../../_data/ossl-tfm/im-targets-lut.csv'
df = pd.read_csv(ossl_source); df.head()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">kex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3998362dd2659e2252cd7f38b43c9b1f.png</td>
<td>0.182895</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2bab4dbbac073b8648475ad50d40eb95.png</td>
<td>0.082741</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>29213d2193232be8867d85dec463ec00.png</td>
<td>0.089915</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>8b1ee9146c026faee20a40df86736864.png</td>
<td>0.135030</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>6e8e9d1105e7da7055555cb5d310df5f.png</td>
<td>0.270421</td>
</tr>
</tbody>
</table>

</div>

``` python
df['kex'].min(), df['kex'].max()
```

    (0.0, 3.6521352871126975)

``` python
# start = np.random.uniform(1, 50); print(start)
# end = np.random.uniform(90.1, 99.5); print(end)
# steps = np.random.randint(5, 100); print(steps)
# percentiles = torch.linspace(start=start, end=end, steps=steps)
# percentiles
```

``` python
from sklearn.model_selection import train_test_split
df_train, df_valid = train_test_split(df, test_size=0.1, random_state=41)
idx_train, idx_valid = df_train.index, df_valid.index
len(idx_train), len(idx_valid)
```

    (51906, 5768)

``` python
def splitter(items): return [idx_train, idx_valid]
```

``` python
OrderedRation
```

``` python
class OrderedQuantize(Quantize):
    order = 0  # Apply first

class OrderedRatioResize(RatioResize):
    order = 1  # Apply second

ossl = DataBlock(
    blocks=(ImageBlock, RegressionBlock),
    get_x=ColReader(0, pref='../../_data/ossl-tfm/im/'),
    get_y=ColReader(1),
    splitter=splitter,
    item_tfms=[OrderedQuantize(n_valid=len(idx_valid))],
    batch_tfms=[
        OrderedRatioResize(224),
        Normalize.from_stats(*imagenet_stats)
    ]
)
```

``` python
ossl = DataBlock(blocks=(ImageBlock, RegressionBlock),
                get_x=ColReader(0, pref='../../_data/ossl-tfm/im/'),
                get_y=ColReader(1),
                # batch_tfms=Normalize.from_stats(*imagenet_stats),
                item_tfms=[Quantize(n_valid=len(idx_valid))],
                batch_tfms=[RatioResize(224), ],
                # splitter=RandomSplitter(valid_pct=0.1, seed=41)
                splitter=splitter
#    batch_tfms=aug_transforms()
)
```

``` python
# ossl.summary(df)
```

``` python
dls = ossl.dataloaders(df)
```

``` python
dls.show_batch(nrows=6, ncols=2, figsize=(12, 13))
```

![](fastai-bw-augment_files/figure-commonmark/cell-14-output-1.png)

``` python
# Unfrozen, 30 epochs, 1.5e-3 => r2: 0.85
# Frozen,
```

``` python
learn = vision_learner(dls, resnet18, pretrained=False, metrics=R2Score()).to_fp16()
```

``` python
# learn = load_learner ('./models/bw-data-augment-0.pkl', cpu=True)
```

``` python
learn.lr_find()
```

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

    <div>
      <progress value='0' class='' max='1' style='width:300px; height:20px; vertical-align: middle;'></progress>
      0.00% [0/1 00:00&lt;?]
    </div>
    &#10;
&#10;    <div>
      <progress value='14' class='' max='811' style='width:300px; height:20px; vertical-align: middle;'></progress>
      1.73% [14/811 00:45&lt;42:44 4.8972]
    </div>
    &#10;
    KeyboardInterrupt: 
    [0;31m---------------------------------------------------------------------------[0m
    [0;31mKeyboardInterrupt[0m                         Traceback (most recent call last)
    Cell [0;32mIn[88], line 1[0m
    [0;32m----> 1[0m [43mlearn[49m[38;5;241;43m.[39;49m[43mlr_find[49m[43m([49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/callback/schedule.py:295[0m, in [0;36mlr_find[0;34m(self, start_lr, end_lr, num_it, stop_div, show_plot, suggest_funcs)[0m
    [1;32m    293[0m n_epoch [38;5;241m=[39m num_it[38;5;241m/[39m[38;5;241m/[39m[38;5;28mlen[39m([38;5;28mself[39m[38;5;241m.[39mdls[38;5;241m.[39mtrain) [38;5;241m+[39m [38;5;241m1[39m
    [1;32m    294[0m cb[38;5;241m=[39mLRFinder(start_lr[38;5;241m=[39mstart_lr, end_lr[38;5;241m=[39mend_lr, num_it[38;5;241m=[39mnum_it, stop_div[38;5;241m=[39mstop_div)
    [0;32m--> 295[0m [38;5;28;01mwith[39;00m [38;5;28mself[39m[38;5;241m.[39mno_logging(): [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mfit[49m[43m([49m[43mn_epoch[49m[43m,[49m[43m [49m[43mcbs[49m[38;5;241;43m=[39;49m[43mcb[49m[43m)[49m
    [1;32m    296[0m [38;5;28;01mif[39;00m suggest_funcs [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
    [1;32m    297[0m     lrs, losses [38;5;241m=[39m tensor([38;5;28mself[39m[38;5;241m.[39mrecorder[38;5;241m.[39mlrs[num_it[38;5;241m/[39m[38;5;241m/[39m[38;5;241m10[39m:[38;5;241m-[39m[38;5;241m5[39m]), tensor([38;5;28mself[39m[38;5;241m.[39mrecorder[38;5;241m.[39mlosses[num_it[38;5;241m/[39m[38;5;241m/[39m[38;5;241m10[39m:[38;5;241m-[39m[38;5;241m5[39m])

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:266[0m, in [0;36mLearner.fit[0;34m(self, n_epoch, lr, wd, cbs, reset_opt, start_epoch)[0m
    [1;32m    264[0m [38;5;28mself[39m[38;5;241m.[39mopt[38;5;241m.[39mset_hypers(lr[38;5;241m=[39m[38;5;28mself[39m[38;5;241m.[39mlr [38;5;28;01mif[39;00m lr [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m [38;5;28;01melse[39;00m lr)
    [1;32m    265[0m [38;5;28mself[39m[38;5;241m.[39mn_epoch [38;5;241m=[39m n_epoch
    [0;32m--> 266[0m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_with_events[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_do_fit[49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43mfit[39;49m[38;5;124;43m'[39;49m[43m,[49m[43m [49m[43mCancelFitException[49m[43m,[49m[43m [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_end_cleanup[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:201[0m, in [0;36mLearner._with_events[0;34m(self, f, event_type, ex, final)[0m
    [1;32m    200[0m [38;5;28;01mdef[39;00m [38;5;21m_with_events[39m([38;5;28mself[39m, f, event_type, ex, final[38;5;241m=[39mnoop):
    [0;32m--> 201[0m     [38;5;28;01mtry[39;00m: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mbefore_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  [43mf[49m[43m([49m[43m)[49m
    [1;32m    202[0m     [38;5;28;01mexcept[39;00m ex: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_cancel_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m)
    [1;32m    203[0m     [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  final()

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:255[0m, in [0;36mLearner._do_fit[0;34m(self)[0m
    [1;32m    253[0m [38;5;28;01mfor[39;00m epoch [38;5;129;01min[39;00m [38;5;28mrange[39m([38;5;28mself[39m[38;5;241m.[39mn_epoch):
    [1;32m    254[0m     [38;5;28mself[39m[38;5;241m.[39mepoch[38;5;241m=[39mepoch
    [0;32m--> 255[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_with_events[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_do_epoch[49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43mepoch[39;49m[38;5;124;43m'[39;49m[43m,[49m[43m [49m[43mCancelEpochException[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:201[0m, in [0;36mLearner._with_events[0;34m(self, f, event_type, ex, final)[0m
    [1;32m    200[0m [38;5;28;01mdef[39;00m [38;5;21m_with_events[39m([38;5;28mself[39m, f, event_type, ex, final[38;5;241m=[39mnoop):
    [0;32m--> 201[0m     [38;5;28;01mtry[39;00m: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mbefore_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  [43mf[49m[43m([49m[43m)[49m
    [1;32m    202[0m     [38;5;28;01mexcept[39;00m ex: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_cancel_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m)
    [1;32m    203[0m     [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  final()

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:249[0m, in [0;36mLearner._do_epoch[0;34m(self)[0m
    [1;32m    248[0m [38;5;28;01mdef[39;00m [38;5;21m_do_epoch[39m([38;5;28mself[39m):
    [0;32m--> 249[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_do_epoch_train[49m[43m([49m[43m)[49m
    [1;32m    250[0m     [38;5;28mself[39m[38;5;241m.[39m_do_epoch_validate()

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:241[0m, in [0;36mLearner._do_epoch_train[0;34m(self)[0m
    [1;32m    239[0m [38;5;28;01mdef[39;00m [38;5;21m_do_epoch_train[39m([38;5;28mself[39m):
    [1;32m    240[0m     [38;5;28mself[39m[38;5;241m.[39mdl [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mdls[38;5;241m.[39mtrain
    [0;32m--> 241[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_with_events[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mall_batches[49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43mtrain[39;49m[38;5;124;43m'[39;49m[43m,[49m[43m [49m[43mCancelTrainException[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:201[0m, in [0;36mLearner._with_events[0;34m(self, f, event_type, ex, final)[0m
    [1;32m    200[0m [38;5;28;01mdef[39;00m [38;5;21m_with_events[39m([38;5;28mself[39m, f, event_type, ex, final[38;5;241m=[39mnoop):
    [0;32m--> 201[0m     [38;5;28;01mtry[39;00m: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mbefore_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  [43mf[49m[43m([49m[43m)[49m
    [1;32m    202[0m     [38;5;28;01mexcept[39;00m ex: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_cancel_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m)
    [1;32m    203[0m     [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  final()

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:207[0m, in [0;36mLearner.all_batches[0;34m(self)[0m
    [1;32m    205[0m [38;5;28;01mdef[39;00m [38;5;21mall_batches[39m([38;5;28mself[39m):
    [1;32m    206[0m     [38;5;28mself[39m[38;5;241m.[39mn_iter [38;5;241m=[39m [38;5;28mlen[39m([38;5;28mself[39m[38;5;241m.[39mdl)
    [0;32m--> 207[0m     [38;5;28;01mfor[39;00m o [38;5;129;01min[39;00m [38;5;28menumerate[39m([38;5;28mself[39m[38;5;241m.[39mdl): [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mone_batch[49m[43m([49m[38;5;241;43m*[39;49m[43mo[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:237[0m, in [0;36mLearner.one_batch[0;34m(self, i, b)[0m
    [1;32m    235[0m b [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39m_set_device(b)
    [1;32m    236[0m [38;5;28mself[39m[38;5;241m.[39m_split(b)
    [0;32m--> 237[0m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_with_events[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_do_one_batch[49m[43m,[49m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43mbatch[39;49m[38;5;124;43m'[39;49m[43m,[49m[43m [49m[43mCancelBatchException[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:203[0m, in [0;36mLearner._with_events[0;34m(self, f, event_type, ex, final)[0m
    [1;32m    201[0m [38;5;28;01mtry[39;00m: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mbefore_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m);  f()
    [1;32m    202[0m [38;5;28;01mexcept[39;00m ex: [38;5;28mself[39m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mafter_cancel_[39m[38;5;132;01m{[39;00mevent_type[38;5;132;01m}[39;00m[38;5;124m'[39m)
    [0;32m--> 203[0m [38;5;28;43mself[39;49m[43m([49m[38;5;124;43mf[39;49m[38;5;124;43m'[39;49m[38;5;124;43mafter_[39;49m[38;5;132;43;01m{[39;49;00m[43mevent_type[49m[38;5;132;43;01m}[39;49;00m[38;5;124;43m'[39;49m[43m)[49m;  final()

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:174[0m, in [0;36mLearner.__call__[0;34m(self, event_name)[0m
    [0;32m--> 174[0m [38;5;28;01mdef[39;00m [38;5;21m__call__[39m([38;5;28mself[39m, event_name): [43mL[49m[43m([49m[43mevent_name[49m[43m)[49m[38;5;241;43m.[39;49m[43mmap[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_call_one[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastcore/foundation.py:159[0m, in [0;36mL.map[0;34m(self, f, *args, **kwargs)[0m
    [0;32m--> 159[0m [38;5;28;01mdef[39;00m [38;5;21mmap[39m([38;5;28mself[39m, f, [38;5;241m*[39margs, [38;5;241m*[39m[38;5;241m*[39mkwargs): [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39m_new([43mmap_ex[49m[43m([49m[38;5;28;43mself[39;49m[43m,[49m[43m [49m[43mf[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[43margs[49m[43m,[49m[43m [49m[43mgen[49m[38;5;241;43m=[39;49m[38;5;28;43;01mFalse[39;49;00m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mkwargs[49m[43m)[49m)

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastcore/basics.py:899[0m, in [0;36mmap_ex[0;34m(iterable, f, gen, *args, **kwargs)[0m
    [1;32m    897[0m res [38;5;241m=[39m [38;5;28mmap[39m(g, iterable)
    [1;32m    898[0m [38;5;28;01mif[39;00m gen: [38;5;28;01mreturn[39;00m res
    [0;32m--> 899[0m [38;5;28;01mreturn[39;00m [38;5;28;43mlist[39;49m[43m([49m[43mres[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastcore/basics.py:884[0m, in [0;36mbind.__call__[0;34m(self, *args, **kwargs)[0m
    [1;32m    882[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(v,_Arg): kwargs[k] [38;5;241m=[39m args[38;5;241m.[39mpop(v[38;5;241m.[39mi)
    [1;32m    883[0m fargs [38;5;241m=[39m [args[x[38;5;241m.[39mi] [38;5;28;01mif[39;00m [38;5;28misinstance[39m(x, _Arg) [38;5;28;01melse[39;00m x [38;5;28;01mfor[39;00m x [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39mpargs] [38;5;241m+[39m args[[38;5;28mself[39m[38;5;241m.[39mmaxi[38;5;241m+[39m[38;5;241m1[39m:]
    [0;32m--> 884[0m [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mfunc[49m[43m([49m[38;5;241;43m*[39;49m[43mfargs[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mkwargs[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:178[0m, in [0;36mLearner._call_one[0;34m(self, event_name)[0m
    [1;32m    176[0m [38;5;28;01mdef[39;00m [38;5;21m_call_one[39m([38;5;28mself[39m, event_name):
    [1;32m    177[0m     [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m [38;5;28mhasattr[39m(event, event_name): [38;5;28;01mraise[39;00m [38;5;167;01mException[39;00m([38;5;124mf[39m[38;5;124m'[39m[38;5;124mmissing [39m[38;5;132;01m{[39;00mevent_name[38;5;132;01m}[39;00m[38;5;124m'[39m)
    [0;32m--> 178[0m     [38;5;28;01mfor[39;00m cb [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39mcbs[38;5;241m.[39msorted([38;5;124m'[39m[38;5;124morder[39m[38;5;124m'[39m): [43mcb[49m[43m([49m[43mevent_name[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/callback/core.py:62[0m, in [0;36mCallback.__call__[0;34m(self, event_name)[0m
    [1;32m     60[0m res [38;5;241m=[39m [38;5;28;01mNone[39;00m
    [1;32m     61[0m [38;5;28;01mif[39;00m [38;5;28mself[39m[38;5;241m.[39mrun [38;5;129;01mand[39;00m _run: 
    [0;32m---> 62[0m     [38;5;28;01mtry[39;00m: res [38;5;241m=[39m [43mgetcallable[49m[43m([49m[38;5;28;43mself[39;49m[43m,[49m[43m [49m[43mevent_name[49m[43m)[49m[43m([49m[43m)[49m
    [1;32m     63[0m     [38;5;28;01mexcept[39;00m (CancelBatchException, CancelBackwardException, CancelEpochException, CancelFitException, CancelStepException, CancelTrainException, CancelValidException): [38;5;28;01mraise[39;00m
    [1;32m     64[0m     [38;5;28;01mexcept[39;00m [38;5;167;01mException[39;00m [38;5;28;01mas[39;00m e: [38;5;28;01mraise[39;00m modify_exception(e, [38;5;124mf[39m[38;5;124m'[39m[38;5;124mException occured in `[39m[38;5;132;01m{[39;00m[38;5;28mself[39m[38;5;241m.[39m[38;5;18m__class__[39m[38;5;241m.[39m[38;5;18m__name__[39m[38;5;132;01m}[39;00m[38;5;124m` when calling event `[39m[38;5;132;01m{[39;00mevent_name[38;5;132;01m}[39;00m[38;5;124m`:[39m[38;5;130;01m\n[39;00m[38;5;130;01m\t[39;00m[38;5;132;01m{[39;00me[38;5;241m.[39margs[[38;5;241m0[39m][38;5;132;01m}[39;00m[38;5;124m'[39m, replace[38;5;241m=[39m[38;5;28;01mTrue[39;00m)

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:562[0m, in [0;36mRecorder.after_batch[0;34m(self)[0m
    [1;32m    560[0m [38;5;28;01mif[39;00m [38;5;28mlen[39m([38;5;28mself[39m[38;5;241m.[39myb) [38;5;241m==[39m [38;5;241m0[39m: [38;5;28;01mreturn[39;00m
    [1;32m    561[0m mets [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39m_train_mets [38;5;28;01mif[39;00m [38;5;28mself[39m[38;5;241m.[39mtraining [38;5;28;01melse[39;00m [38;5;28mself[39m[38;5;241m.[39m_valid_mets
    [0;32m--> 562[0m [38;5;28;01mfor[39;00m met [38;5;129;01min[39;00m mets: [43mmet[49m[38;5;241;43m.[39;49m[43maccumulate[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mlearn[49m[43m)[49m
    [1;32m    563[0m [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m [38;5;28mself[39m[38;5;241m.[39mtraining: [38;5;28;01mreturn[39;00m
    [1;32m    564[0m [38;5;28mself[39m[38;5;241m.[39mlrs[38;5;241m.[39mappend([38;5;28mself[39m[38;5;241m.[39mopt[38;5;241m.[39mhypers[[38;5;241m-[39m[38;5;241m1[39m][[38;5;124m'[39m[38;5;124mlr[39m[38;5;124m'[39m])

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/learner.py:511[0m, in [0;36mAvgSmoothLoss.accumulate[0;34m(self, learn)[0m
    [1;32m    509[0m [38;5;28;01mdef[39;00m [38;5;21maccumulate[39m([38;5;28mself[39m, learn):
    [1;32m    510[0m     [38;5;28mself[39m[38;5;241m.[39mcount [38;5;241m+[39m[38;5;241m=[39m [38;5;241m1[39m
    [0;32m--> 511[0m     [38;5;28mself[39m[38;5;241m.[39mval [38;5;241m=[39m torch[38;5;241m.[39mlerp([43mto_detach[49m[43m([49m[43mlearn[49m[38;5;241;43m.[39;49m[43mloss[49m[38;5;241;43m.[39;49m[43mmean[49m[43m([49m[43m)[49m[43m)[49m, [38;5;28mself[39m[38;5;241m.[39mval, [38;5;28mself[39m[38;5;241m.[39mbeta)

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/torch_core.py:246[0m, in [0;36mto_detach[0;34m(b, cpu, gather)[0m
    [1;32m    244[0m     [38;5;28;01mif[39;00m gather: x [38;5;241m=[39m maybe_gather(x)
    [1;32m    245[0m     [38;5;28;01mreturn[39;00m x[38;5;241m.[39mcpu() [38;5;28;01mif[39;00m cpu [38;5;28;01melse[39;00m x
    [0;32m--> 246[0m [38;5;28;01mreturn[39;00m [43mapply[49m[43m([49m[43m_inner[49m[43m,[49m[43m [49m[43mb[49m[43m,[49m[43m [49m[43mcpu[49m[38;5;241;43m=[39;49m[43mcpu[49m[43m,[49m[43m [49m[43mgather[49m[38;5;241;43m=[39;49m[43mgather[49m[43m)[49m

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/torch_core.py:226[0m, in [0;36mapply[0;34m(func, x, *args, **kwargs)[0m
    [1;32m    224[0m [38;5;28;01mif[39;00m is_listy(x): [38;5;28;01mreturn[39;00m [38;5;28mtype[39m(x)([apply(func, o, [38;5;241m*[39margs, [38;5;241m*[39m[38;5;241m*[39mkwargs) [38;5;28;01mfor[39;00m o [38;5;129;01min[39;00m x])
    [1;32m    225[0m [38;5;28;01mif[39;00m [38;5;28misinstance[39m(x,([38;5;28mdict[39m,MutableMapping)): [38;5;28;01mreturn[39;00m {k: apply(func, v, [38;5;241m*[39margs, [38;5;241m*[39m[38;5;241m*[39mkwargs) [38;5;28;01mfor[39;00m k,v [38;5;129;01min[39;00m x[38;5;241m.[39mitems()}
    [0;32m--> 226[0m res [38;5;241m=[39m [43mfunc[49m[43m([49m[43mx[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[43margs[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mkwargs[49m[43m)[49m
    [1;32m    227[0m [38;5;28;01mreturn[39;00m res [38;5;28;01mif[39;00m x [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m [38;5;28;01melse[39;00m retain_type(res, x)

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/torch_core.py:245[0m, in [0;36mto_detach.<locals>._inner[0;34m(x, cpu, gather)[0m
    [1;32m    243[0m x [38;5;241m=[39m x[38;5;241m.[39mdetach()
    [1;32m    244[0m [38;5;28;01mif[39;00m gather: x [38;5;241m=[39m maybe_gather(x)
    [0;32m--> 245[0m [38;5;28;01mreturn[39;00m [43mx[49m[38;5;241;43m.[39;49m[43mcpu[49m[43m([49m[43m)[49m [38;5;28;01mif[39;00m cpu [38;5;28;01melse[39;00m x

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastai/torch_core.py:384[0m, in [0;36mTensorBase.__torch_function__[0;34m(cls, func, types, args, kwargs)[0m
    [1;32m    382[0m [38;5;28;01mif[39;00m [38;5;28mcls[39m[38;5;241m.[39mdebug [38;5;129;01mand[39;00m func[38;5;241m.[39m[38;5;18m__name__[39m [38;5;129;01mnot[39;00m [38;5;129;01min[39;00m ([38;5;124m'[39m[38;5;124m__str__[39m[38;5;124m'[39m,[38;5;124m'[39m[38;5;124m__repr__[39m[38;5;124m'[39m): [38;5;28mprint[39m(func, types, args, kwargs)
    [1;32m    383[0m [38;5;28;01mif[39;00m _torch_handled(args, [38;5;28mcls[39m[38;5;241m.[39m_opt, func): types [38;5;241m=[39m (torch[38;5;241m.[39mTensor,)
    [0;32m--> 384[0m res [38;5;241m=[39m [38;5;28;43msuper[39;49m[43m([49m[43m)[49m[38;5;241;43m.[39;49m[43m__torch_function__[49m[43m([49m[43mfunc[49m[43m,[49m[43m [49m[43mtypes[49m[43m,[49m[43m [49m[43margs[49m[43m,[49m[43m [49m[43mifnone[49m[43m([49m[43mkwargs[49m[43m,[49m[43m [49m[43m{[49m[43m}[49m[43m)[49m[43m)[49m
    [1;32m    385[0m dict_objs [38;5;241m=[39m _find_args(args) [38;5;28;01mif[39;00m args [38;5;28;01melse[39;00m _find_args([38;5;28mlist[39m(kwargs[38;5;241m.[39mvalues()))
    [1;32m    386[0m [38;5;28;01mif[39;00m [38;5;28missubclass[39m([38;5;28mtype[39m(res),TensorBase) [38;5;129;01mand[39;00m dict_objs: res[38;5;241m.[39mset_meta(dict_objs[[38;5;241m0[39m],as_copy[38;5;241m=[39m[38;5;28;01mTrue[39;00m)

    File [0;32m~/mambaforge/envs/uhina/lib/python3.12/site-packages/torch/_tensor.py:1437[0m, in [0;36mTensor.__torch_function__[0;34m(cls, func, types, args, kwargs)[0m
    [1;32m   1434[0m     [38;5;28;01mreturn[39;00m [38;5;28mNotImplemented[39m
    [1;32m   1436[0m [38;5;28;01mwith[39;00m _C[38;5;241m.[39mDisableTorchFunctionSubclass():
    [0;32m-> 1437[0m     ret [38;5;241m=[39m [43mfunc[49m[43m([49m[38;5;241;43m*[39;49m[43margs[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mkwargs[49m[43m)[49m
    [1;32m   1438[0m     [38;5;28;01mif[39;00m func [38;5;129;01min[39;00m get_default_nowrap_functions():
    [1;32m   1439[0m         [38;5;28;01mreturn[39;00m ret

    [0;31mKeyboardInterrupt[0m: 

``` python
# learn.fit_one_cycle(5, 3e-3)
```

## Evaluation

``` python
val_preds, val_targets = learn.get_preds(dl=dls.valid)
```

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

``` python
val_preds_tta, val_targets_tta = learn.tta(dl=dls.valid)
```

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

    <div>
      <progress value='0' class='' max='20' style='width:300px; height:20px; vertical-align: middle;'></progress>
      &#10;    </div>
    

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

``` python
# EXAMPLE of TTA on single item
# from fastai.vision.all import *

# # Define your TTA transforms
# tta_tfms = [
#     RandomResizedCrop(224, min_scale=0.5),
#     Flip(),
#     Rotate(degrees=(-15, 15)),
#     Brightness(max_lighting=0.2),
#     Contrast(max_lighting=0.2)
# ]

# # Create a pipeline of TTA transformations
# tta_pipeline = Pipeline(tta_tfms)

# # Load your model
# learn = load_learner('path/to/your/model.pkl')

# # Define the input data (e.g., an image)
# input_data = PILImage.create('path/to/your/image.jpg')

# # Apply TTA transforms to the input data and make predictions
# predictions = []
# for _ in range(5):  # Apply 5 different augmentations
#     augmented_data = tta_pipeline(input_data)
#     prediction = learn.predict(augmented_data)
#     predictions.append(prediction)

# # Average the predictions
# average_prediction = sum(predictions) / len(predictions)

# print(average_prediction)
```

``` python
# Assuming you have a new CSV file for your test data
# test_source = '../../_data/ossl-tfm/ossl-tfm-test.csv'
# test_df = pd.read_csv(test_source)

# # Create a new DataLoader for the test data
# test_dl = learn.dls.test_dl(test_df)

# # Get predictions on the test set
# test_preds, test_targets = learn.get_preds(dl=test_dl)

# # Now you can use test_preds and test_targets for further analysis
```

``` python
# Convert predictions and targets to numpy arrays
def assess_model(val_preds, val_targets):
    val_preds = val_preds.numpy().flatten()
    val_targets = val_targets.numpy()

    # Create a DataFrame with the results
    results_df = pd.DataFrame({
        'Predicted': val_preds,
        'Actual': val_targets
    })

    # Display the first few rows of the results
    print(results_df.head())

    # Calculate and print the R2 score
    from sklearn.metrics import r2_score
    r2 = r2_score(val_targets, val_preds)
    print(f"R2 Score on validation set: {r2:.4f}")
```

``` python
assess_model(val_preds, val_targets)
```

       Predicted    Actual
    0   0.312483  0.000000
    1   0.126990  0.184960
    2   0.365726  0.194201
    3   0.239089  0.262364
    4   0.402980  0.355799
    R2 Score on validation set: 0.8325

``` python
assess_model(val_preds_tta, val_targets_tta)
```

       Predicted    Actual
    0   0.246857  0.000000
    1   0.148590  0.184960
    2   0.371643  0.194201
    3   0.226535  0.262364
    4   0.407333  0.355799
    R2 Score on validation set: 0.8378

``` python
val_preds_np = val_preds
val_targets_np = val_targets

# Apply the transformation: exp(y) - 1
val_preds_transformed = np.exp(val_preds_np) - 1
val_targets_transformed = np.exp(val_targets_np) - 1

# Create a DataFrame with the results
results_df = pd.DataFrame({
    'Predicted': val_preds_transformed,
    'Actual': val_targets_transformed
})

# Display the first few rows of the results
print(results_df.head())

# Calculate and print the R2 score
from sklearn.metrics import r2_score
r2 = r2_score(val_targets_transformed, val_preds_transformed)
print(f"R2 Score on validation set (after transformation): {r2:.4f}")

# Calculate and print the MAPE, handling zero values
def mean_absolute_percentage_error(y_true, y_pred):
    non_zero = (y_true != 0)
    return np.mean(np.abs((y_true[non_zero] - y_pred[non_zero]) / y_true[non_zero])) * 100

mape = mean_absolute_percentage_error(val_targets_transformed, val_preds_transformed)
print(f"Mean Absolute Percentage Error (MAPE) on validation set: {mape:.2f}%")

# Calculate and print the MAE as an alternative metric
from sklearn.metrics import mean_absolute_error
mae = mean_absolute_error(val_targets_transformed, val_preds_transformed)
print(f"Mean Absolute Error (MAE) on validation set: {mae:.4f}")
```

       Predicted   Actual
    0   0.366814  0.00000
    1   0.135405  0.20317
    2   0.441560  0.21434
    3   0.270092  0.30000
    4   0.496277  0.42732
    R2 Score on validation set (after transformation): 0.6936
    Mean Absolute Percentage Error (MAPE) on validation set: 50.72%
    Mean Absolute Error (MAE) on validation set: 0.1956

``` python
plt.figure(figsize=(6, 6))

# Use logarithmic bins for the colormap
h = plt.hexbin(val_targets, val_preds, gridsize=65, 
               bins='log', cmap='Spectral_r', mincnt=1,
               alpha=0.9)

# Get the actual min and max counts from the hexbin data
counts = h.get_array()
min_count = counts[counts > 0].min()  # Minimum non-zero count
max_count = counts.max()

# Create a logarithmic colorbar
cb = plt.colorbar(h, label='Count in bin', shrink=0.73)
tick_locations = np.logspace(np.log10(min_count), np.log10(max_count), 5)
cb.set_ticks(tick_locations)
cb.set_ticklabels([f'{int(x)}' for x in tick_locations])

# Add the diagonal line
min_val = min(val_targets.min(), val_preds.min())
max_val = max(val_targets.max(), val_preds.max())
plt.plot([min_val, max_val], [min_val, max_val], 'k--', lw=1)

# Set labels and title
plt.xlabel('Actual Values')
plt.ylabel('Predicted Values')
plt.title('Predicted vs Actual Values (Hexbin with Log Scale)')

# Add grid lines
plt.grid(True, linestyle='--', alpha=0.65)

# Set the same limits for both axes
plt.xlim(min_val, max_val)
plt.ylim(min_val, max_val)

# Make the plot square
plt.gca().set_aspect('equal', adjustable='box')

plt.tight_layout()
plt.show()

# Print the range of counts in the hexbins
print(f"Min non-zero count in hexbins: {min_count}")
print(f"Max count in hexbins: {max_count}")
```

![](fastai-bw-augment_files/figure-commonmark/cell-28-output-1.png)

    Min non-zero count in hexbins: 1.0
    Max count in hexbins: 157.0

``` python
path_model = Path('./models')
learn.export(path_model / '0.pkl')
```

## Inference

``` python
ossl_source = Path('../../_data/ossl-tfm/img')
learn.predict(ossl_source / '0a0a0c647671fd3030cc13ba5432eb88.png')
```

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

    ((0.5229991674423218,), tensor([0.5230]), tensor([0.5230]))

``` python
df[df['fname'] == '0a0a0c647671fd3030cc13ba5432eb88.png']
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&#10;    .dataframe tbody tr th {
        vertical-align: top;
    }
&#10;    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">kex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">28867</td>
<td>0a0a0c647671fd3030cc13ba5432eb88.png</td>
<td>0.525379</td>
</tr>
</tbody>
</table>

</div>

``` python
np.exp(3) - 1
```

    19.085536923187668

## Experiments:

Color scale: `viridis` | Discretization:
`percentiles = [i for i in range(60, 100)]`

<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 11%" />
<col style="width: 15%" />
<col style="width: 7%" />
<col style="width: 9%" />
<col style="width: 15%" />
<col style="width: 11%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>with axis ticks</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>100</td>
<td>1e-3</td>
<td>10</td>
<td>0.648</td>
<td>05:12</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.69</td>
<td>07:30</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>ResNet-18</td>
<td>750 (original size)</td>
<td>1e-3</td>
<td>10</td>
<td>0.71</td>
<td>36:00</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>20</td>
<td>0.704</td>
<td>07:30</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.71</td>
<td>07:00</td>
<td>No</td>
<td>No</td>
</tr>
</tbody>
</table>

Discretization: `percentiles = [i for i in range(20, 100)]`

<table style="width:100%;">
<colgroup>
<col style="width: 9%" />
<col style="width: 10%" />
<col style="width: 13%" />
<col style="width: 6%" />
<col style="width: 8%" />
<col style="width: 13%" />
<col style="width: 10%" />
<col style="width: 14%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>with axis ticks</th>
<th>colour scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.7</td>
<td>05:12</td>
<td>No</td>
<td>No</td>
<td><code>viridis</code></td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>3e-3</td>
<td>10</td>
<td>0.71</td>
<td>05:12</td>
<td>No</td>
<td>No</td>
<td><code>jet</code></td>
</tr>
</tbody>
</table>

From now on `with axis ticks` is always `No`.

Discretization: esimated on `10000` cwt power percentiles
`[20, 30, 40, 50, 60, 70, 80, 90, 95, 97, 99]`

<table style="width:100%;">
<colgroup>
<col style="width: 9%" />
<col style="width: 10%" />
<col style="width: 13%" />
<col style="width: 6%" />
<col style="width: 8%" />
<col style="width: 13%" />
<col style="width: 10%" />
<col style="width: 14%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>remark</th>
<th>colour scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.71</td>
<td>05:12</td>
<td>No</td>
<td>None</td>
<td><code>jet</code></td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.685</td>
<td>05:12</td>
<td>No</td>
<td>y range added</td>
<td><code>jet</code></td>
</tr>
</tbody>
</table>

From now on random splitter with `10%` validation and random seed `41`.

Discretization: esimated on `10000` cwt power percentiles
`[20, 30, 40, 50, 60, 70, 80, 90, 95, 97, 99]`

<table style="width:100%;">
<colgroup>
<col style="width: 9%" />
<col style="width: 10%" />
<col style="width: 13%" />
<col style="width: 6%" />
<col style="width: 8%" />
<col style="width: 13%" />
<col style="width: 10%" />
<col style="width: 14%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>remark</th>
<th>colour scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.7</td>
<td>05:12</td>
<td>No</td>
<td>Pre-train &amp; normalize: True</td>
<td><code>jet</code></td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.796</td>
<td>08:12</td>
<td>No</td>
<td>No Pre-train</td>
<td><code>jet</code></td>
</tr>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>3e-3</td>
<td>10</td>
<td>0.7</td>
<td>05:12</td>
<td>No</td>
<td>Pre-train &amp; normalize: False</td>
<td><code>jet</code></td>
</tr>
<tr class="even">
<td>ResNet-18 (id=0)</td>
<td>224</td>
<td>2e-3</td>
<td>20</td>
<td><strong>0.829</strong></td>
<td>08:12</td>
<td>No</td>
<td>No Pre-train (try 18 epochs)</td>
<td><code>jet</code></td>
</tr>
</tbody>
</table>
