<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Evaluation Resnet 18 pre-trained on OSSL dataset on ringtrial data.">

<title>Ringtrial – uhina</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Ringtrial – uhina">
<meta property="og:description" content="Evaluation Resnet 18 pre-trained on OSSL dataset on ringtrial data.">
<meta property="og:site_name" content="uhina">
<meta name="twitter:title" content="Ringtrial – uhina">
<meta name="twitter:description" content="Evaluation Resnet 18 pre-trained on OSSL dataset on ringtrial data.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">uhina</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../example/fastai-bw-augment.html">example</a></li><li class="breadcrumb-item"><a href="../example/ringtrial.html">Ringtrial</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Uhina</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../loading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loading</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preprocessing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wavelets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Continuous Wavelet Transform</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cli.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Command Line Interface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../augment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data augmentation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">example</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/fastai-bw-augment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fastai BW data augmentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/fastai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fastai example</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/fk-jumpei-classic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fukushima Jumpei classic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/fk-jumpei-transfer-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fukushima Jumpei transfer learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/ossl-vs-fk-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OSSL vs Ringtrial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/ossl-vs-ringtrial-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OSSL vs Ringtrial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/ringtrial-classic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ringtrial classic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/ringtrial.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Ringtrial</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">history_runpod</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/history_runpod/fastai-bw-augment-03-10-2024.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fastai BW data augmentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/history_runpod/fastai-bw-augment-12-10-2024.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fastai BW data augmentation</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#runpod-setup" id="toc-runpod-setup" class="nav-link active" data-scroll-target="#runpod-setup">Runpod setup</a></li>
  <li><a href="#loading-data" id="toc-loading-data" class="nav-link" data-scroll-target="#loading-data">Loading data</a></li>
  <li><a href="#fine-tuning-on-ringtrial" id="toc-fine-tuning-on-ringtrial" class="nav-link" data-scroll-target="#fine-tuning-on-ringtrial">Fine-tuning on ringtrial</a>
  <ul class="collapse">
  <li><a href="#trainvalidtest-split" id="toc-trainvalidtest-split" class="nav-link" data-scroll-target="#trainvalidtest-split">Train/valid/test split</a></li>
  <li><a href="#evaluate-fine-tuned-model" id="toc-evaluate-fine-tuned-model" class="nav-link" data-scroll-target="#evaluate-fine-tuned-model">Evaluate fine-tuned model</a></li>
  <li><a href="#on-single-images" id="toc-on-single-images" class="nav-link" data-scroll-target="#on-single-images">On single images</a></li>
  </ul></li>
  <li><a href="#evaluation" id="toc-evaluation" class="nav-link" data-scroll-target="#evaluation">Evaluation</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments">Experiments:</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/franckalbinet/uhina/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="ringtrial.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../example/fastai-bw-augment.html">example</a></li><li class="breadcrumb-item"><a href="../example/ringtrial.html">Ringtrial</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Ringtrial</h1>
</div>

<div>
  <div class="description">
    Evaluation Resnet 18 pre-trained on OSSL dataset on ringtrial data.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>To do:</p>
<pre><code>- for each lab, fine-tune and eval on test set
  - use TTA and at what n it starts leveling off?
  - increase progressively train, valid, test set sizes
- normalize on ringtrial statistics</code></pre>
<section id="runpod-setup" class="level2">
<h2 class="anchored" data-anchor-id="runpod-setup">Runpod setup</h2>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setting up pod and pip install uhina</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># accessing a pod terminal</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. To get access to the pod ip adress: runpodctl get pod -a</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. ssh into the pod: ssh root@&lt;ip-address&gt; -p 58871 -i ~/.ssh/id_ed25519</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># git clone https://github.com/franckalbinet/uhina.git</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># pip install uhina</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># runpodctl send im-bw </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># runpodctl send ossl-tfm.csv</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-data">Loading data</h2>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastcore.<span class="bu">all</span> <span class="im">as</span> fc</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.data.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> multiprocessing <span class="im">import</span> cpu_count</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> uhina.augment <span class="im">import</span> Quantize</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> <span class="st">'../../_data/ringtrial-tfm/im-targets-lut.csv'</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(src)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'lab'</span>] <span class="op">=</span> df[<span class="st">'fname'</span>].<span class="bu">str</span>.split(<span class="st">'-rt'</span>, n<span class="op">=</span><span class="dv">1</span>).<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>agrocares-rt-01.png</td>
<td>0.26906</td>
<td>agrocares</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>agrocares-rt-02.png</td>
<td>0.23349</td>
<td>agrocares</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>agrocares-rt-03.png</td>
<td>0.29109</td>
<td>agrocares</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>agrocares-rt-04.png</td>
<td>0.49925</td>
<td>agrocares</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>agrocares-rt-05.png</td>
<td>0.59977</td>
<td>agrocares</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'potassium_cmolkg'</span>] <span class="op">=</span> df[<span class="st">'potassium_cmolkg'</span>].<span class="bu">apply</span>(np.log1p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fine-tuning-on-ringtrial" class="level2">
<h2 class="anchored" data-anchor-id="fine-tuning-on-ringtrial">Fine-tuning on ringtrial</h2>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderedQuantize(Quantize):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Apply first</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderedRatioResize(RatioResize):</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Apply second</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = load_learner('./models/650-4000-epoch-25-lr-3e-3.pkl', cpu=True)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = load_learner('./models/unfrozen-epoch-30-lr-1.5e-3-12102024.pkl', cpu=True)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = load_learner('./models/unfrozen-epoch-30-lr-1.5e-3-12102024.pkl', cpu=True)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> load_learner(<span class="st">'./models/frozen-epoch-30-lr-1.5e-3-12102024.pkl'</span>, cpu<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df.lab.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array(['agrocares', 'argonne', 'csu-il', 'eth-alpha-1', 'eth-alpha-2',
       'eth-vertex', 'iaea-aug2022', 'kssl', 'landcare', 'lesotho', 'msu',
       'osu', 'rothamsted', 'scion', 'ughent', 'uiuc', 'usp',
       'uwisc-fine', 'woodwell-alpha', 'woodwell-vertex'], dtype=object)</code></pre>
</div>
</div>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># np.expm1(np.log1p(2))</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df_selected <span class="op">=</span> df[df.lab <span class="op">==</span> <span class="st">'kssl'</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df_selected.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">483</td>
<td>kssl-rt-01.png</td>
<td>0.238276</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">484</td>
<td>kssl-rt-02.png</td>
<td>0.209848</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">485</td>
<td>kssl-rt-03.png</td>
<td>0.255487</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">486</td>
<td>kssl-rt-04.png</td>
<td>0.404965</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">487</td>
<td>kssl-rt-05.png</td>
<td>0.469860</td>
<td>kssl</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># def splitter(items): return [idx_train, idx_valid]</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>eval_on_pretrained <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> eval_on_pretrained:  </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    dblock <span class="op">=</span> DataBlock(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        blocks<span class="op">=</span>(ImageBlock, RegressionBlock),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        get_x<span class="op">=</span>ColReader(<span class="dv">0</span>, pref<span class="op">=</span><span class="st">'../../_data/ringtrial-tfm/im/'</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        get_y<span class="op">=</span>ColReader(<span class="dv">1</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># splitter=splitter,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="dv">0</span>, seed<span class="op">=</span><span class="dv">41</span>),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        item_tfms<span class="op">=</span>[OrderedQuantize(n_valid<span class="op">=</span><span class="bu">len</span>(df_selected))],</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        batch_tfms<span class="op">=</span>[</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            OrderedRatioResize(<span class="dv">224</span>),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            Normalize.from_stats(<span class="op">*</span>imagenet_stats)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> dblock.dataloaders(df_selected, bs<span class="op">=</span><span class="bu">len</span>(df_selected))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    val_preds, val_targets <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.train)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(val_targets, val_preds)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Eval on pre-trained model</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># eval_on_pretrained = True</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># if eval_on_pretrained:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     dblock = DataBlock(</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         blocks=(ImageBlock, RegressionBlock),</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         get_x=ColReader(0, pref='../../_data/ringtrial-tfm/im/'),</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         get_y=ColReader(1),</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         splitter=RandomSplitter(valid_pct=0, seed=41),</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         batch_tfms=[RatioResize(224)],</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         item_tfms=[Quantize(n_valid=len(df_selected))])</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     dls = dblock.dataloaders(df_selected, bs=len(df_selected))</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     val_preds, val_targets = learn.get_preds(dl=dls.train)</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     r2 = r2_score(val_targets, val_preds)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(r2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_selected.loc[:, <span class="st">'potassium_cmolkg'</span>] <span class="op">=</span> df_selected[<span class="st">'potassium_cmolkg'</span>].<span class="bu">apply</span>(np.log1p)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_selected.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">483</td>
<td>kssl-rt-01.png</td>
<td>0.213720</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">484</td>
<td>kssl-rt-02.png</td>
<td>0.190494</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">485</td>
<td>kssl-rt-03.png</td>
<td>0.227523</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">486</td>
<td>kssl-rt-04.png</td>
<td>0.340012</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">487</td>
<td>kssl-rt-05.png</td>
<td>0.385167</td>
<td>kssl</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_selected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">483</td>
<td>kssl-rt-01.png</td>
<td>0.213720</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">484</td>
<td>kssl-rt-02.png</td>
<td>0.190494</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">485</td>
<td>kssl-rt-03.png</td>
<td>0.227523</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">486</td>
<td>kssl-rt-04.png</td>
<td>0.340012</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">487</td>
<td>kssl-rt-05.png</td>
<td>0.385167</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">488</td>
<td>kssl-rt-06.png</td>
<td>0.402441</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">489</td>
<td>kssl-rt-07.png</td>
<td>0.331974</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">490</td>
<td>kssl-rt-08.png</td>
<td>0.101317</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">491</td>
<td>kssl-rt-09.png</td>
<td>0.681530</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">492</td>
<td>kssl-rt-10.png</td>
<td>0.274231</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">493</td>
<td>kssl-rt-11.png</td>
<td>0.289119</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">494</td>
<td>kssl-rt-12.png</td>
<td>0.256386</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">495</td>
<td>kssl-rt-13.png</td>
<td>0.369230</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">496</td>
<td>kssl-rt-14.png</td>
<td>0.191284</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">497</td>
<td>kssl-rt-15.png</td>
<td>0.393472</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">498</td>
<td>kssl-rt-16.png</td>
<td>0.508054</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">499</td>
<td>kssl-rt-17.png</td>
<td>0.467364</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">500</td>
<td>kssl-rt-18.png</td>
<td>0.308044</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">501</td>
<td>kssl-rt-19.png</td>
<td>0.292841</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">502</td>
<td>kssl-rt-20.png</td>
<td>0.294769</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">503</td>
<td>kssl-rt-21.png</td>
<td>0.335060</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">504</td>
<td>kssl-rt-22.png</td>
<td>0.079189</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">505</td>
<td>kssl-rt-23.png</td>
<td>0.272119</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">506</td>
<td>kssl-rt-24.png</td>
<td>0.160069</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">507</td>
<td>kssl-rt-25.png</td>
<td>0.158562</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">508</td>
<td>kssl-rt-26.png</td>
<td>0.144258</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">509</td>
<td>kssl-rt-27.png</td>
<td>0.137756</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">510</td>
<td>kssl-rt-28.png</td>
<td>0.516908</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">511</td>
<td>kssl-rt-29.png</td>
<td>0.267374</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">512</td>
<td>kssl-rt-30.png</td>
<td>0.301326</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">513</td>
<td>kssl-rt-31.png</td>
<td>0.306298</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">514</td>
<td>kssl-rt-32.png</td>
<td>0.291591</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">515</td>
<td>kssl-rt-33.png</td>
<td>0.373274</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">516</td>
<td>kssl-rt-34.png</td>
<td>0.100724</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">517</td>
<td>kssl-rt-35.png</td>
<td>0.082217</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">518</td>
<td>kssl-rt-36.png</td>
<td>0.142215</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">519</td>
<td>kssl-rt-37.png</td>
<td>0.126304</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">520</td>
<td>kssl-rt-38.png</td>
<td>0.045243</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">521</td>
<td>kssl-rt-39.png</td>
<td>0.334103</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">522</td>
<td>kssl-rt-40.png</td>
<td>0.515146</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">523</td>
<td>kssl-rt-41.png</td>
<td>0.531581</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">524</td>
<td>kssl-rt-42.png</td>
<td>0.351257</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">525</td>
<td>kssl-rt-43.png</td>
<td>0.233260</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">526</td>
<td>kssl-rt-45.png</td>
<td>0.271288</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">527</td>
<td>kssl-rt-46.png</td>
<td>0.307444</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">528</td>
<td>kssl-rt-47.png</td>
<td>0.256559</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">529</td>
<td>kssl-rt-48.png</td>
<td>0.544772</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">530</td>
<td>kssl-rt-49.png</td>
<td>0.366122</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">531</td>
<td>kssl-rt-50.png</td>
<td>0.542601</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">532</td>
<td>kssl-rt-51.png</td>
<td>0.547084</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">533</td>
<td>kssl-rt-52.png</td>
<td>0.283886</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">534</td>
<td>kssl-rt-53.png</td>
<td>0.337035</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">535</td>
<td>kssl-rt-54.png</td>
<td>0.284184</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">536</td>
<td>kssl-rt-55.png</td>
<td>0.306663</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">537</td>
<td>kssl-rt-56.png</td>
<td>0.541332</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">538</td>
<td>kssl-rt-57.png</td>
<td>0.548911</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">539</td>
<td>kssl-rt-58.png</td>
<td>0.551454</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">540</td>
<td>kssl-rt-59.png</td>
<td>0.380625</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541</td>
<td>kssl-rt-60.png</td>
<td>0.462484</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">542</td>
<td>kssl-rt-61.png</td>
<td>0.379143</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">543</td>
<td>kssl-rt-62.png</td>
<td>0.223065</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">544</td>
<td>kssl-rt-63.png</td>
<td>0.223065</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">545</td>
<td>kssl-rt-64.png</td>
<td>0.131506</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">546</td>
<td>kssl-rt-65.png</td>
<td>0.226245</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">547</td>
<td>kssl-rt-66.png</td>
<td>0.852376</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">548</td>
<td>kssl-rt-67.png</td>
<td>0.619430</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">549</td>
<td>kssl-rt-68.png</td>
<td>0.486798</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">550</td>
<td>kssl-rt-69.png</td>
<td>0.519743</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">551</td>
<td>kssl-rt-70.png</td>
<td>0.551429</td>
<td>kssl</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_selected[<span class="st">'potassium_cmolkg'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="trainvalidtest-split" class="level3">
<h3 class="anchored" data-anchor-id="trainvalidtest-split">Train/valid/test split</h3>
<section id="using-kennard-stone" class="level4">
<h4 class="anchored" data-anchor-id="using-kennard-stone">Using Kennard-Stone</h4>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df.lab.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array(['agrocares', 'argonne', 'csu-il', 'eth-alpha-1', 'eth-alpha-2',
       'eth-vertex', 'iaea-aug2022', 'kssl', 'landcare', 'lesotho', 'msu',
       'osu', 'rothamsted', 'scion', 'ughent', 'uiuc', 'usp',
       'uwisc-fine', 'woodwell-alpha', 'woodwell-vertex'], dtype=object)</code></pre>
</div>
</div>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_selected <span class="op">=</span> df[df.lab <span class="op">==</span> <span class="st">'kssl'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df_selected)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>69</code></pre>
</div>
</div>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> uhina.loading <span class="im">import</span> LoaderFactory</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>src <span class="op">=</span> Path.home() <span class="op">/</span> <span class="st">'pro/data/woodwell-ringtrial/drive-download-20231013T123706Z-001'</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>loader <span class="op">=</span> LoaderFactory.get_loader(src, <span class="st">'ringtrial'</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> loader.load_data(analytes<span class="op">=</span><span class="st">'potassium_cmolkg'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'X shape: </span><span class="sc">{</span>data<span class="sc">.</span>X<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X shape: (1400, 1676)</code></pre>
</div>
</div>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 44 is missing</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>indices_df <span class="op">=</span> [name.split(<span class="st">'.png'</span>)[<span class="dv">0</span>] <span class="cf">for</span> name <span class="kw">in</span> df_selected.fname]<span class="op">;</span> indices_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['kssl-rt-01',
 'kssl-rt-02',
 'kssl-rt-03',
 'kssl-rt-04',
 'kssl-rt-05',
 'kssl-rt-06',
 'kssl-rt-07',
 'kssl-rt-08',
 'kssl-rt-09',
 'kssl-rt-10',
 'kssl-rt-11',
 'kssl-rt-12',
 'kssl-rt-13',
 'kssl-rt-14',
 'kssl-rt-15',
 'kssl-rt-16',
 'kssl-rt-17',
 'kssl-rt-18',
 'kssl-rt-19',
 'kssl-rt-20',
 'kssl-rt-21',
 'kssl-rt-22',
 'kssl-rt-23',
 'kssl-rt-24',
 'kssl-rt-25',
 'kssl-rt-26',
 'kssl-rt-27',
 'kssl-rt-28',
 'kssl-rt-29',
 'kssl-rt-30',
 'kssl-rt-31',
 'kssl-rt-32',
 'kssl-rt-33',
 'kssl-rt-34',
 'kssl-rt-35',
 'kssl-rt-36',
 'kssl-rt-37',
 'kssl-rt-38',
 'kssl-rt-39',
 'kssl-rt-40',
 'kssl-rt-41',
 'kssl-rt-42',
 'kssl-rt-43',
 'kssl-rt-45',
 'kssl-rt-46',
 'kssl-rt-47',
 'kssl-rt-48',
 'kssl-rt-49',
 'kssl-rt-50',
 'kssl-rt-51',
 'kssl-rt-52',
 'kssl-rt-53',
 'kssl-rt-54',
 'kssl-rt-55',
 'kssl-rt-56',
 'kssl-rt-57',
 'kssl-rt-58',
 'kssl-rt-59',
 'kssl-rt-60',
 'kssl-rt-61',
 'kssl-rt-62',
 'kssl-rt-63',
 'kssl-rt-64',
 'kssl-rt-65',
 'kssl-rt-66',
 'kssl-rt-67',
 'kssl-rt-68',
 'kssl-rt-69',
 'kssl-rt-70']</code></pre>
</div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.isin(data.sample_indices, np.array(indices_df))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>data.sample_indices[mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array(['kssl-rt-01', 'kssl-rt-02', 'kssl-rt-03', 'kssl-rt-04',
       'kssl-rt-05', 'kssl-rt-06', 'kssl-rt-07', 'kssl-rt-08',
       'kssl-rt-09', 'kssl-rt-10', 'kssl-rt-11', 'kssl-rt-12',
       'kssl-rt-13', 'kssl-rt-14', 'kssl-rt-15', 'kssl-rt-16',
       'kssl-rt-17', 'kssl-rt-18', 'kssl-rt-19', 'kssl-rt-20',
       'kssl-rt-21', 'kssl-rt-22', 'kssl-rt-23', 'kssl-rt-24',
       'kssl-rt-25', 'kssl-rt-26', 'kssl-rt-27', 'kssl-rt-28',
       'kssl-rt-29', 'kssl-rt-30', 'kssl-rt-31', 'kssl-rt-32',
       'kssl-rt-33', 'kssl-rt-34', 'kssl-rt-35', 'kssl-rt-36',
       'kssl-rt-37', 'kssl-rt-38', 'kssl-rt-39', 'kssl-rt-40',
       'kssl-rt-41', 'kssl-rt-42', 'kssl-rt-43', 'kssl-rt-45',
       'kssl-rt-46', 'kssl-rt-47', 'kssl-rt-48', 'kssl-rt-49',
       'kssl-rt-50', 'kssl-rt-51', 'kssl-rt-52', 'kssl-rt-53',
       'kssl-rt-54', 'kssl-rt-55', 'kssl-rt-56', 'kssl-rt-57',
       'kssl-rt-58', 'kssl-rt-59', 'kssl-rt-60', 'kssl-rt-61',
       'kssl-rt-62', 'kssl-rt-63', 'kssl-rt-64', 'kssl-rt-65',
       'kssl-rt-66', 'kssl-rt-67', 'kssl-rt-68', 'kssl-rt-69',
       'kssl-rt-70'], dtype=object)</code></pre>
</div>
</div>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>data.sample_indices[mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array(['kssl-rt-01', 'kssl-rt-02', 'kssl-rt-03', 'kssl-rt-04',
       'kssl-rt-05', 'kssl-rt-06', 'kssl-rt-07', 'kssl-rt-08',
       'kssl-rt-09', 'kssl-rt-10', 'kssl-rt-11', 'kssl-rt-12',
       'kssl-rt-13', 'kssl-rt-14', 'kssl-rt-15', 'kssl-rt-16',
       'kssl-rt-17', 'kssl-rt-18', 'kssl-rt-19', 'kssl-rt-20',
       'kssl-rt-21', 'kssl-rt-22', 'kssl-rt-23', 'kssl-rt-24',
       'kssl-rt-25', 'kssl-rt-26', 'kssl-rt-27', 'kssl-rt-28',
       'kssl-rt-29', 'kssl-rt-30', 'kssl-rt-31', 'kssl-rt-32',
       'kssl-rt-33', 'kssl-rt-34', 'kssl-rt-35', 'kssl-rt-36',
       'kssl-rt-37', 'kssl-rt-38', 'kssl-rt-39', 'kssl-rt-40',
       'kssl-rt-41', 'kssl-rt-42', 'kssl-rt-43', 'kssl-rt-45',
       'kssl-rt-46', 'kssl-rt-47', 'kssl-rt-48', 'kssl-rt-49',
       'kssl-rt-50', 'kssl-rt-51', 'kssl-rt-52', 'kssl-rt-53',
       'kssl-rt-54', 'kssl-rt-55', 'kssl-rt-56', 'kssl-rt-57',
       'kssl-rt-58', 'kssl-rt-59', 'kssl-rt-60', 'kssl-rt-61',
       'kssl-rt-62', 'kssl-rt-63', 'kssl-rt-64', 'kssl-rt-65',
       'kssl-rt-66', 'kssl-rt-67', 'kssl-rt-68', 'kssl-rt-69',
       'kssl-rt-70'], dtype=object)</code></pre>
</div>
</div>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_selected.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>data.sample_indices[mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array(['kssl-rt-01', 'kssl-rt-02', 'kssl-rt-03', 'kssl-rt-04',
       'kssl-rt-05', 'kssl-rt-06', 'kssl-rt-07', 'kssl-rt-08',
       'kssl-rt-09', 'kssl-rt-10', 'kssl-rt-11', 'kssl-rt-12',
       'kssl-rt-13', 'kssl-rt-14', 'kssl-rt-15', 'kssl-rt-16',
       'kssl-rt-17', 'kssl-rt-18', 'kssl-rt-19', 'kssl-rt-20',
       'kssl-rt-21', 'kssl-rt-22', 'kssl-rt-23', 'kssl-rt-24',
       'kssl-rt-25', 'kssl-rt-26', 'kssl-rt-27', 'kssl-rt-28',
       'kssl-rt-29', 'kssl-rt-30', 'kssl-rt-31', 'kssl-rt-32',
       'kssl-rt-33', 'kssl-rt-34', 'kssl-rt-35', 'kssl-rt-36',
       'kssl-rt-37', 'kssl-rt-38', 'kssl-rt-39', 'kssl-rt-40',
       'kssl-rt-41', 'kssl-rt-42', 'kssl-rt-43', 'kssl-rt-45',
       'kssl-rt-46', 'kssl-rt-47', 'kssl-rt-48', 'kssl-rt-49',
       'kssl-rt-50', 'kssl-rt-51', 'kssl-rt-52', 'kssl-rt-53',
       'kssl-rt-54', 'kssl-rt-55', 'kssl-rt-56', 'kssl-rt-57',
       'kssl-rt-58', 'kssl-rt-59', 'kssl-rt-60', 'kssl-rt-61',
       'kssl-rt-62', 'kssl-rt-63', 'kssl-rt-64', 'kssl-rt-65',
       'kssl-rt-66', 'kssl-rt-67', 'kssl-rt-68', 'kssl-rt-69',
       'kssl-rt-70'], dtype=object)</code></pre>
</div>
</div>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mask = np.char.find(data.sample_indices.astype(str), 'kssl') != -1</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>X_lab, y_lab <span class="op">=</span> data.X[mask], np.log1p(data.y[mask])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>data.sample_indices[mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array(['kssl-rt-01', 'kssl-rt-02', 'kssl-rt-03', 'kssl-rt-04',
       'kssl-rt-05', 'kssl-rt-06', 'kssl-rt-07', 'kssl-rt-08',
       'kssl-rt-09', 'kssl-rt-10', 'kssl-rt-11', 'kssl-rt-12',
       'kssl-rt-13', 'kssl-rt-14', 'kssl-rt-15', 'kssl-rt-16',
       'kssl-rt-17', 'kssl-rt-18', 'kssl-rt-19', 'kssl-rt-20',
       'kssl-rt-21', 'kssl-rt-22', 'kssl-rt-23', 'kssl-rt-24',
       'kssl-rt-25', 'kssl-rt-26', 'kssl-rt-27', 'kssl-rt-28',
       'kssl-rt-29', 'kssl-rt-30', 'kssl-rt-31', 'kssl-rt-32',
       'kssl-rt-33', 'kssl-rt-34', 'kssl-rt-35', 'kssl-rt-36',
       'kssl-rt-37', 'kssl-rt-38', 'kssl-rt-39', 'kssl-rt-40',
       'kssl-rt-41', 'kssl-rt-42', 'kssl-rt-43', 'kssl-rt-45',
       'kssl-rt-46', 'kssl-rt-47', 'kssl-rt-48', 'kssl-rt-49',
       'kssl-rt-50', 'kssl-rt-51', 'kssl-rt-52', 'kssl-rt-53',
       'kssl-rt-54', 'kssl-rt-55', 'kssl-rt-56', 'kssl-rt-57',
       'kssl-rt-58', 'kssl-rt-59', 'kssl-rt-60', 'kssl-rt-61',
       'kssl-rt-62', 'kssl-rt-63', 'kssl-rt-64', 'kssl-rt-65',
       'kssl-rt-66', 'kssl-rt-67', 'kssl-rt-68', 'kssl-rt-69',
       'kssl-rt-70'], dtype=object)</code></pre>
</div>
</div>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_selected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>kssl-rt-01.png</td>
<td>0.238276</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>kssl-rt-02.png</td>
<td>0.209848</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>kssl-rt-03.png</td>
<td>0.255487</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>kssl-rt-04.png</td>
<td>0.404965</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>kssl-rt-05.png</td>
<td>0.469860</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>kssl-rt-06.png</td>
<td>0.495470</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>kssl-rt-07.png</td>
<td>0.393716</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>kssl-rt-08.png</td>
<td>0.106628</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>kssl-rt-09.png</td>
<td>0.976900</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>kssl-rt-10.png</td>
<td>0.315519</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>kssl-rt-11.png</td>
<td>0.335250</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>kssl-rt-12.png</td>
<td>0.292252</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>kssl-rt-13.png</td>
<td>0.446620</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>kssl-rt-14.png</td>
<td>0.210804</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>kssl-rt-15.png</td>
<td>0.482117</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>kssl-rt-16.png</td>
<td>0.662054</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>kssl-rt-17.png</td>
<td>0.595782</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>kssl-rt-18.png</td>
<td>0.360761</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>kssl-rt-19.png</td>
<td>0.340229</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>kssl-rt-20.png</td>
<td>0.342816</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>kssl-rt-21.png</td>
<td>0.398024</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>kssl-rt-22.png</td>
<td>0.082409</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>kssl-rt-23.png</td>
<td>0.312743</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>kssl-rt-24.png</td>
<td>0.173592</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>kssl-rt-25.png</td>
<td>0.171825</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>kssl-rt-26.png</td>
<td>0.155182</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>kssl-rt-27.png</td>
<td>0.147696</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>kssl-rt-28.png</td>
<td>0.676835</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>kssl-rt-29.png</td>
<td>0.306528</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>kssl-rt-30.png</td>
<td>0.351649</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>kssl-rt-31.png</td>
<td>0.358387</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>kssl-rt-32.png</td>
<td>0.338556</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>kssl-rt-33.png</td>
<td>0.452482</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>kssl-rt-34.png</td>
<td>0.105971</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>kssl-rt-35.png</td>
<td>0.085691</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>kssl-rt-36.png</td>
<td>0.152824</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>kssl-rt-37.png</td>
<td>0.134627</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>kssl-rt-38.png</td>
<td>0.046282</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>kssl-rt-39.png</td>
<td>0.396687</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>kssl-rt-40.png</td>
<td>0.673883</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40</td>
<td>kssl-rt-41.png</td>
<td>0.701621</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">41</td>
<td>kssl-rt-42.png</td>
<td>0.420853</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>kssl-rt-43.png</td>
<td>0.262710</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>kssl-rt-45.png</td>
<td>0.311652</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>kssl-rt-46.png</td>
<td>0.359945</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">45</td>
<td>kssl-rt-47.png</td>
<td>0.292476</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46</td>
<td>kssl-rt-48.png</td>
<td>0.724215</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47</td>
<td>kssl-rt-49.png</td>
<td>0.442131</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>kssl-rt-50.png</td>
<td>0.720475</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49</td>
<td>kssl-rt-51.png</td>
<td>0.728205</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>kssl-rt-52.png</td>
<td>0.328282</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>kssl-rt-53.png</td>
<td>0.400788</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>kssl-rt-54.png</td>
<td>0.328678</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>kssl-rt-55.png</td>
<td>0.358884</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54</td>
<td>kssl-rt-56.png</td>
<td>0.718293</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">55</td>
<td>kssl-rt-57.png</td>
<td>0.731367</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>kssl-rt-58.png</td>
<td>0.735776</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57</td>
<td>kssl-rt-59.png</td>
<td>0.463199</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>kssl-rt-60.png</td>
<td>0.588014</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>kssl-rt-61.png</td>
<td>0.461032</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60</td>
<td>kssl-rt-62.png</td>
<td>0.249902</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">61</td>
<td>kssl-rt-63.png</td>
<td>0.249902</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62</td>
<td>kssl-rt-64.png</td>
<td>0.140544</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>kssl-rt-65.png</td>
<td>0.253882</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>kssl-rt-66.png</td>
<td>1.345212</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65</td>
<td>kssl-rt-67.png</td>
<td>0.857869</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>kssl-rt-68.png</td>
<td>0.627098</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">67</td>
<td>kssl-rt-69.png</td>
<td>0.681596</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">68</td>
<td>kssl-rt-70.png</td>
<td>0.735732</td>
<td>kssl</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>X_lab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[1.2708 , 1.26602, 1.26191, ..., 0.15597, 0.15574, 0.15549],
       [1.68078, 1.69329, 1.70438, ..., 0.22922, 0.22891, 0.22859],
       [1.69767, 1.69935, 1.70112, ..., 0.38133, 0.38056, 0.3798 ],
       ...,
       [1.65483, 1.65777, 1.6626 , ..., 0.22134, 0.22078, 0.2202 ],
       [1.86684, 1.86213, 1.85727, ..., 0.14837, 0.14783, 0.14725],
       [1.62302, 1.62296, 1.62328, ..., 0.2393 , 0.23909, 0.23888]])</code></pre>
</div>
</div>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> uhina.preprocessing <span class="im">import</span> SNV, TakeDerivative</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline([</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'SNV'</span>, SNV()),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Derivative'</span>, TakeDerivative())</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>X_lab_trans <span class="op">=</span> pipe.fit_transform(X_lab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df_selected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>kssl-rt-01.png</td>
<td>0.238276</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>kssl-rt-02.png</td>
<td>0.209848</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>kssl-rt-03.png</td>
<td>0.255487</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>kssl-rt-04.png</td>
<td>0.404965</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>kssl-rt-05.png</td>
<td>0.469860</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>kssl-rt-06.png</td>
<td>0.495470</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>kssl-rt-07.png</td>
<td>0.393716</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>kssl-rt-08.png</td>
<td>0.106628</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>kssl-rt-09.png</td>
<td>0.976900</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>kssl-rt-10.png</td>
<td>0.315519</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>kssl-rt-11.png</td>
<td>0.335250</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>kssl-rt-12.png</td>
<td>0.292252</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>kssl-rt-13.png</td>
<td>0.446620</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>kssl-rt-14.png</td>
<td>0.210804</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>kssl-rt-15.png</td>
<td>0.482117</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>kssl-rt-16.png</td>
<td>0.662054</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>kssl-rt-17.png</td>
<td>0.595782</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>kssl-rt-18.png</td>
<td>0.360761</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>kssl-rt-19.png</td>
<td>0.340229</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>kssl-rt-20.png</td>
<td>0.342816</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>kssl-rt-21.png</td>
<td>0.398024</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>kssl-rt-22.png</td>
<td>0.082409</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>kssl-rt-23.png</td>
<td>0.312743</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>kssl-rt-24.png</td>
<td>0.173592</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>kssl-rt-25.png</td>
<td>0.171825</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>kssl-rt-26.png</td>
<td>0.155182</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>kssl-rt-27.png</td>
<td>0.147696</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>kssl-rt-28.png</td>
<td>0.676835</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>kssl-rt-29.png</td>
<td>0.306528</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>kssl-rt-30.png</td>
<td>0.351649</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>kssl-rt-31.png</td>
<td>0.358387</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>kssl-rt-32.png</td>
<td>0.338556</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>kssl-rt-33.png</td>
<td>0.452482</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>kssl-rt-34.png</td>
<td>0.105971</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>kssl-rt-35.png</td>
<td>0.085691</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>kssl-rt-36.png</td>
<td>0.152824</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>kssl-rt-37.png</td>
<td>0.134627</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>kssl-rt-38.png</td>
<td>0.046282</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>kssl-rt-39.png</td>
<td>0.396687</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>kssl-rt-40.png</td>
<td>0.673883</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40</td>
<td>kssl-rt-41.png</td>
<td>0.701621</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">41</td>
<td>kssl-rt-42.png</td>
<td>0.420853</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>kssl-rt-43.png</td>
<td>0.262710</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>kssl-rt-45.png</td>
<td>0.311652</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>kssl-rt-46.png</td>
<td>0.359945</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">45</td>
<td>kssl-rt-47.png</td>
<td>0.292476</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46</td>
<td>kssl-rt-48.png</td>
<td>0.724215</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47</td>
<td>kssl-rt-49.png</td>
<td>0.442131</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>kssl-rt-50.png</td>
<td>0.720475</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49</td>
<td>kssl-rt-51.png</td>
<td>0.728205</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>kssl-rt-52.png</td>
<td>0.328282</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>kssl-rt-53.png</td>
<td>0.400788</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>kssl-rt-54.png</td>
<td>0.328678</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>kssl-rt-55.png</td>
<td>0.358884</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54</td>
<td>kssl-rt-56.png</td>
<td>0.718293</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">55</td>
<td>kssl-rt-57.png</td>
<td>0.731367</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>kssl-rt-58.png</td>
<td>0.735776</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57</td>
<td>kssl-rt-59.png</td>
<td>0.463199</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>kssl-rt-60.png</td>
<td>0.588014</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>kssl-rt-61.png</td>
<td>0.461032</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60</td>
<td>kssl-rt-62.png</td>
<td>0.249902</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">61</td>
<td>kssl-rt-63.png</td>
<td>0.249902</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62</td>
<td>kssl-rt-64.png</td>
<td>0.140544</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>kssl-rt-65.png</td>
<td>0.253882</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>kssl-rt-66.png</td>
<td>1.345212</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65</td>
<td>kssl-rt-67.png</td>
<td>0.857869</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>kssl-rt-68.png</td>
<td>0.627098</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">67</td>
<td>kssl-rt-69.png</td>
<td>0.681596</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">68</td>
<td>kssl-rt-70.png</td>
<td>0.735732</td>
<td>kssl</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>X_lab_trans.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(69, 1676)</code></pre>
</div>
</div>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kennard_stone <span class="im">as</span> ks</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># train_idx, valid_idx, X_train, X_valid = ks.train_test_split(np.array(range(len(X_lab_trans))).reshape(-1, 1), </span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                              X_lab_trans, test_size = 0.2)</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># train_idx = train_idx.ravel()</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># valid_idx = valid_idx.ravel()</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>X_train, X_valid, train_idx, valid_idx <span class="op">=</span> ks.train_test_split(X_lab_trans, </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                                                             <span class="bu">range</span>(<span class="bu">len</span>(X_lab_trans)), </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                                                             test_size <span class="op">=</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating pairwise distances using scikit-learn.
Calculating pairwise distances using scikit-learn.</code></pre>
</div>
</div>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>valid_idx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[35, 6, 24, 12, 3, 31, 30, 5, 2, 25, 49, 28, 44, 40]</code></pre>
</div>
</div>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>df_selected.loc[train_idx, :][<span class="st">'potassium_cmolkg'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df_selected.loc[valid_idx, :][<span class="st">'potassium_cmolkg'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-42" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cross_decomposition <span class="im">import</span> PLSRegression</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> []</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">20</span>):</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    pls <span class="op">=</span> PLSRegression(n_components<span class="op">=</span>n)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    pls.fit(X_lab_trans[train_idx], y_lab[train_idx])</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    y_predicted <span class="op">=</span> pls.predict(X_lab_trans[valid_idx])</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(n, r2_score(y_predicted, y_lab[valid_idx]))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    scores.append(r2_score(y_predicted, y_lab[valid_idx]))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">20</span>), scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 0.9167139331659132
2 0.8169940843443368
3 0.8201480463134329
4 0.8330463354402591
5 0.8336164418584839
6 0.8066819139016866
7 0.8063689082131712
8 0.8476483270390328
9 0.8442719648387733
10 0.8550880328401899
11 0.85550155049048
12 0.8773457853046793
13 0.8640833529184554
14 0.8467865332449903
15 0.8598890265246808
16 0.860227416062531
17 0.8890976617393181
18 0.8975066928044428
19 0.9022963785020354</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-36-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>pls <span class="op">=</span> PLSRegression(n_components<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>pls.fit(X_lab_trans[train_idx], np.log1p(data.y[mask][train_idx]))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>y_predicted <span class="op">=</span> pls.predict(X_lab_trans[valid_idx])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> y_predicted, np.log1p(data.y[mask][valid_idx])</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>plt.plot(x, y, <span class="st">'.'</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the diagonal line</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>min_val <span class="op">=</span> <span class="bu">min</span>(y.<span class="bu">min</span>(), x.<span class="bu">min</span>())</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> <span class="bu">max</span>(y.<span class="bu">max</span>(), x.<span class="bu">max</span>())</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>plt.plot([min_val, max_val], [min_val, max_val], <span class="st">'k--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dblock = DataBlock(blocks=(ImageBlock, RegressionBlock),</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                    get_x=ColReader(0, pref='../../_data/ringtrial-tfm/im/'),</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                    get_y=ColReader(1),</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                    splitter=RandomSplitter(valid_pct=0, seed=41),</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                    batch_tfms=[RatioResize(224)],</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                    item_tfms=[Quantize()])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># class ModelEvaluator:</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     def __init__(self, model_path, dblock):</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">#         self.learn = load_learner(model_path, cpu=True)</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#         self.dblock = dblock</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     def evaluate(self, df_selected, batch_size=16, use_tta=False, tta_n=4):</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         dls = self.dblock.dataloaders(df_selected, bs=batch_size)</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         if use_tta:</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">#             val_preds, val_targets = self.learn.tta(dl=dls.train, n=tta_n)</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         else:</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co">#             val_preds, val_targets = self.learn.get_preds(dl=dls.train)</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         r2 = r2_score(val_targets, val_preds)</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         return val_preds, val_targets, r2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model_path = './models/650-4000-epoch-25-lr-3e-3.pkl'</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluator = ModelEvaluator(model_path, dblock)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_idx), <span class="bu">len</span>(valid_idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(55, 14)</code></pre>
</div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> has_common_elements(list1, list2): <span class="cf">return</span> <span class="bu">bool</span>(<span class="bu">set</span>(list1) <span class="op">&amp;</span> <span class="bu">set</span>(list2))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fc.test_eq(has_common_elements(train_idx, valid_idx), <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>df_selected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>eth-alpha-1-rt-01.png</td>
<td>0.238276</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>eth-alpha-1-rt-02.png</td>
<td>0.209848</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>eth-alpha-1-rt-03.png</td>
<td>0.255487</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>eth-alpha-1-rt-04.png</td>
<td>0.404965</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>eth-alpha-1-rt-05.png</td>
<td>0.469860</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>eth-alpha-1-rt-06.png</td>
<td>0.495470</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>eth-alpha-1-rt-07.png</td>
<td>0.393716</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>eth-alpha-1-rt-08.png</td>
<td>0.106628</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>eth-alpha-1-rt-09.png</td>
<td>0.976900</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>eth-alpha-1-rt-10.png</td>
<td>0.315519</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>eth-alpha-1-rt-11.png</td>
<td>0.335250</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>eth-alpha-1-rt-12.png</td>
<td>0.292252</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>eth-alpha-1-rt-13.png</td>
<td>0.446620</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>eth-alpha-1-rt-14.png</td>
<td>0.210804</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>eth-alpha-1-rt-15.png</td>
<td>0.482117</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>eth-alpha-1-rt-16.png</td>
<td>0.662054</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>eth-alpha-1-rt-17.png</td>
<td>0.595782</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>eth-alpha-1-rt-18.png</td>
<td>0.360761</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>eth-alpha-1-rt-19.png</td>
<td>0.340229</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>eth-alpha-1-rt-20.png</td>
<td>0.342816</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>eth-alpha-1-rt-21.png</td>
<td>0.398024</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>eth-alpha-1-rt-22.png</td>
<td>0.082409</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>eth-alpha-1-rt-23.png</td>
<td>0.312743</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>eth-alpha-1-rt-24.png</td>
<td>0.173592</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>eth-alpha-1-rt-25.png</td>
<td>0.171825</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>eth-alpha-1-rt-26.png</td>
<td>0.155182</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>eth-alpha-1-rt-27.png</td>
<td>0.147696</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>eth-alpha-1-rt-28.png</td>
<td>0.676835</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>eth-alpha-1-rt-29.png</td>
<td>0.306528</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>eth-alpha-1-rt-30.png</td>
<td>0.351649</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>eth-alpha-1-rt-31.png</td>
<td>0.358387</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>eth-alpha-1-rt-32.png</td>
<td>0.338556</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>eth-alpha-1-rt-33.png</td>
<td>0.452482</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>eth-alpha-1-rt-34.png</td>
<td>0.105971</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>eth-alpha-1-rt-35.png</td>
<td>0.085691</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>eth-alpha-1-rt-36.png</td>
<td>0.152824</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>eth-alpha-1-rt-37.png</td>
<td>0.134627</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>eth-alpha-1-rt-38.png</td>
<td>0.046282</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>eth-alpha-1-rt-39.png</td>
<td>0.396687</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>eth-alpha-1-rt-40.png</td>
<td>0.673883</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40</td>
<td>eth-alpha-1-rt-41.png</td>
<td>0.701621</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">41</td>
<td>eth-alpha-1-rt-42.png</td>
<td>0.420853</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>eth-alpha-1-rt-43.png</td>
<td>0.262710</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>eth-alpha-1-rt-45.png</td>
<td>0.311652</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>eth-alpha-1-rt-46.png</td>
<td>0.359945</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">45</td>
<td>eth-alpha-1-rt-47.png</td>
<td>0.292476</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46</td>
<td>eth-alpha-1-rt-48.png</td>
<td>0.724215</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47</td>
<td>eth-alpha-1-rt-49.png</td>
<td>0.442131</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>eth-alpha-1-rt-50.png</td>
<td>0.720475</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49</td>
<td>eth-alpha-1-rt-51.png</td>
<td>0.728205</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>eth-alpha-1-rt-52.png</td>
<td>0.328282</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>eth-alpha-1-rt-53.png</td>
<td>0.400788</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>eth-alpha-1-rt-54.png</td>
<td>0.328678</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>eth-alpha-1-rt-55.png</td>
<td>0.358884</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54</td>
<td>eth-alpha-1-rt-56.png</td>
<td>0.718293</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">55</td>
<td>eth-alpha-1-rt-57.png</td>
<td>0.731367</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>eth-alpha-1-rt-58.png</td>
<td>0.735776</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57</td>
<td>eth-alpha-1-rt-59.png</td>
<td>0.463199</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>eth-alpha-1-rt-60.png</td>
<td>0.588014</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>eth-alpha-1-rt-61.png</td>
<td>0.461032</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60</td>
<td>eth-alpha-1-rt-62.png</td>
<td>0.249902</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">61</td>
<td>eth-alpha-1-rt-63.png</td>
<td>0.249902</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62</td>
<td>eth-alpha-1-rt-64.png</td>
<td>0.140544</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>eth-alpha-1-rt-65.png</td>
<td>0.253882</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>eth-alpha-1-rt-66.png</td>
<td>1.345212</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65</td>
<td>eth-alpha-1-rt-67.png</td>
<td>0.857869</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>eth-alpha-1-rt-68.png</td>
<td>0.627098</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">67</td>
<td>eth-alpha-1-rt-69.png</td>
<td>0.681596</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">68</td>
<td>eth-alpha-1-rt-70.png</td>
<td>0.735732</td>
<td>eth-alpha-1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df_selected.loc[train_idx, :]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>eth-alpha-1-rt-16.png</td>
<td>0.662054</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16</td>
<td>eth-alpha-1-rt-17.png</td>
<td>0.595782</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46</td>
<td>eth-alpha-1-rt-48.png</td>
<td>0.724215</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49</td>
<td>eth-alpha-1-rt-51.png</td>
<td>0.728205</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>eth-alpha-1-rt-50.png</td>
<td>0.720475</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>eth-alpha-1-rt-61.png</td>
<td>0.461032</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">47</td>
<td>eth-alpha-1-rt-49.png</td>
<td>0.442131</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">54</td>
<td>eth-alpha-1-rt-56.png</td>
<td>0.718293</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">39</td>
<td>eth-alpha-1-rt-40.png</td>
<td>0.673883</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">36</td>
<td>eth-alpha-1-rt-37.png</td>
<td>0.134627</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">55</td>
<td>eth-alpha-1-rt-57.png</td>
<td>0.731367</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>eth-alpha-1-rt-55.png</td>
<td>0.358884</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>eth-alpha-1-rt-58.png</td>
<td>0.735776</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>eth-alpha-1-rt-08.png</td>
<td>0.106628</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>eth-alpha-1-rt-31.png</td>
<td>0.358387</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">61</td>
<td>eth-alpha-1-rt-63.png</td>
<td>0.249902</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">45</td>
<td>eth-alpha-1-rt-47.png</td>
<td>0.292476</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">52</td>
<td>eth-alpha-1-rt-54.png</td>
<td>0.328678</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">37</td>
<td>eth-alpha-1-rt-38.png</td>
<td>0.046282</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>eth-alpha-1-rt-53.png</td>
<td>0.400788</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>eth-alpha-1-rt-46.png</td>
<td>0.359945</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>eth-alpha-1-rt-06.png</td>
<td>0.495470</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">65</td>
<td>eth-alpha-1-rt-67.png</td>
<td>0.857869</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>eth-alpha-1-rt-12.png</td>
<td>0.292252</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>eth-alpha-1-rt-60.png</td>
<td>0.588014</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">64</td>
<td>eth-alpha-1-rt-66.png</td>
<td>1.345212</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57</td>
<td>eth-alpha-1-rt-59.png</td>
<td>0.463199</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">68</td>
<td>eth-alpha-1-rt-70.png</td>
<td>0.735732</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>eth-alpha-1-rt-01.png</td>
<td>0.238276</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>eth-alpha-1-rt-14.png</td>
<td>0.210804</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>eth-alpha-1-rt-68.png</td>
<td>0.627098</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>eth-alpha-1-rt-65.png</td>
<td>0.253882</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>eth-alpha-1-rt-39.png</td>
<td>0.396687</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>eth-alpha-1-rt-45.png</td>
<td>0.311652</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33</td>
<td>eth-alpha-1-rt-34.png</td>
<td>0.105971</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>eth-alpha-1-rt-26.png</td>
<td>0.155182</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">19</td>
<td>eth-alpha-1-rt-20.png</td>
<td>0.342816</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>eth-alpha-1-rt-28.png</td>
<td>0.676835</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60</td>
<td>eth-alpha-1-rt-62.png</td>
<td>0.249902</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>eth-alpha-1-rt-11.png</td>
<td>0.335250</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>eth-alpha-1-rt-35.png</td>
<td>0.085691</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">40</td>
<td>eth-alpha-1-rt-41.png</td>
<td>0.701621</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">67</td>
<td>eth-alpha-1-rt-69.png</td>
<td>0.681596</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20</td>
<td>eth-alpha-1-rt-21.png</td>
<td>0.398024</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>eth-alpha-1-rt-02.png</td>
<td>0.209848</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24</td>
<td>eth-alpha-1-rt-25.png</td>
<td>0.171825</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>eth-alpha-1-rt-09.png</td>
<td>0.976900</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">32</td>
<td>eth-alpha-1-rt-33.png</td>
<td>0.452482</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>eth-alpha-1-rt-03.png</td>
<td>0.255487</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>eth-alpha-1-rt-22.png</td>
<td>0.082409</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>eth-alpha-1-rt-43.png</td>
<td>0.262710</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">22</td>
<td>eth-alpha-1-rt-23.png</td>
<td>0.312743</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62</td>
<td>eth-alpha-1-rt-64.png</td>
<td>0.140544</td>
<td>eth-alpha-1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">26</td>
<td>eth-alpha-1-rt-27.png</td>
<td>0.147696</td>
<td>eth-alpha-1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">41</td>
<td>eth-alpha-1-rt-42.png</td>
<td>0.420853</td>
<td>eth-alpha-1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ks_splitter(items): <span class="cf">return</span> [train_idx, valid_idx]</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, RegressionBlock),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span>ColReader(<span class="dv">0</span>, pref<span class="op">=</span><span class="st">'../../_data/ringtrial-tfm/im/'</span>),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>ColReader(<span class="dv">1</span>),</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    splitter <span class="op">=</span> ks_splitter,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>[OrderedQuantize(n_valid<span class="op">=</span><span class="bu">len</span>(valid_idx))],</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>[</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    OrderedRatioResize(<span class="dv">224</span>),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    Normalize.from_stats(<span class="op">*</span>imagenet_stats)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(df_selected, bs<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> load_learner(<span class="st">'./models/frozen-epoch-30-lr-1.5e-3-12102024.pkl'</span>, cpu<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>learn.dls <span class="op">=</span> dls</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>learn.freeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.001737800776027143)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-47-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">10</span>, <span class="fl">1.5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.062678</td>
<td>0.070659</td>
<td>-7.250715</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.060883</td>
<td>0.032091</td>
<td>-2.747149</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.064407</td>
<td>0.013675</td>
<td>-0.596789</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.052951</td>
<td>0.005511</td>
<td>0.356464</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.048459</td>
<td>0.005013</td>
<td>0.414687</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.043682</td>
<td>0.005526</td>
<td>0.354736</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.039910</td>
<td>0.006038</td>
<td>0.294921</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.036788</td>
<td>0.006592</td>
<td>0.230292</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.034137</td>
<td>0.006361</td>
<td>0.257186</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.032073</td>
<td>0.006753</td>
<td>0.211423</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># val_preds, val_targets = learn.get_preds(dl=dls.valid)</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>val_preds, val_targets <span class="op">=</span> learn.tta(dl<span class="op">=</span>dls.valid, n<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>r2_score(val_targets, val_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="10" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>0.8524203732220106</code></pre>
</div>
</div>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> val_preds, val_targets</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>plt.plot(x, y, <span class="st">'.'</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the diagonal line</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>min_val <span class="op">=</span> <span class="bu">min</span>(y.<span class="bu">min</span>(), x.<span class="bu">min</span>())</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> <span class="bu">max</span>(y.<span class="bu">max</span>(), x.<span class="bu">max</span>())</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>plt.plot([min_val, max_val], [min_val, max_val], <span class="st">'k--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-50-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="using-cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="using-cross-validation">Using cross-validation</h4>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cross_validation(df, target, valid_size<span class="op">=</span><span class="fl">0.2</span>, </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                     num_bins<span class="op">=</span><span class="dv">2</span>, epochs<span class="op">=</span><span class="dv">1</span>, lr<span class="op">=</span><span class="fl">1.5e-3</span>, </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                     n_tta<span class="op">=</span><span class="dv">10</span>, seed<span class="op">=</span><span class="dv">31</span>):</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    train_df, valid_df <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span>valid_size, </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>                                          stratify<span class="op">=</span>pd.qcut(df[target], q<span class="op">=</span>num_bins, labels<span class="op">=</span><span class="va">False</span>), </span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>                                          random_state<span class="op">=</span>seed)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    train_idx, valid_idx <span class="op">=</span> train_df.index, valid_df.index</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stratified_splitter(items): <span class="cf">return</span> [train_idx, valid_idx]</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    dblock <span class="op">=</span> DataBlock(</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        blocks<span class="op">=</span>(ImageBlock, RegressionBlock),</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        get_x<span class="op">=</span>ColReader(<span class="dv">0</span>, pref<span class="op">=</span><span class="st">'../../_data/ringtrial-tfm/im/'</span>),</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        get_y<span class="op">=</span>ColReader(<span class="dv">1</span>),</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>        splitter<span class="op">=</span>stratified_splitter,</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>        item_tfms<span class="op">=</span>[OrderedQuantize(n_valid<span class="op">=</span><span class="bu">len</span>(valid_idx))],</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>        batch_tfms<span class="op">=</span>[</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>        OrderedRatioResize(<span class="dv">224</span>),</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        Normalize.from_stats(<span class="op">*</span>imagenet_stats)</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    dls <span class="op">=</span> dblock.dataloaders(df, bs<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    learn <span class="op">=</span> load_learner(<span class="st">'./models/frozen-epoch-30-lr-1.5e-3-12102024.pkl'</span>, cpu<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    learn.dls <span class="op">=</span> dls</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    learn.freeze()</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    learn.fit_one_cycle(epochs, lr)</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># val_preds, val_targets = learn.get_preds(dl=dls.valid)</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    val_preds, val_targets <span class="op">=</span> learn.tta(dl<span class="op">=</span>dls.valid, n<span class="op">=</span>n_tta)</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r2_score(val_targets, val_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df_selected <span class="op">=</span> df[df.lab <span class="op">==</span> <span class="st">'kssl'</span>]</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> []</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> seed <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> cross_validation(df_selected, <span class="st">'potassium_cmolkg'</span>, </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>                             valid_size<span class="op">=</span><span class="fl">0.2</span>, num_bins<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>                             epochs<span class="op">=</span><span class="dv">3</span>, seed<span class="op">=</span>seed)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    scores.append(score )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.080839</td>
<td>0.318125</td>
<td>0.302815</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.073392</td>
<td>0.298006</td>
<td>0.346907</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.065199</td>
<td>0.292256</td>
<td>0.359508</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.078712</td>
<td>0.058278</td>
<td>0.567448</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.103297</td>
<td>0.037975</td>
<td>0.718140</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.106955</td>
<td>0.029388</td>
<td>0.781878</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.040163</td>
<td>0.132989</td>
<td>0.170330</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.085821</td>
<td>0.117681</td>
<td>0.265833</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.085760</td>
<td>0.110825</td>
<td>0.308603</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.073621</td>
<td>0.045193</td>
<td>0.553941</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.106387</td>
<td>0.029305</td>
<td>0.710762</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.082117</td>
<td>0.021391</td>
<td>0.788873</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.077322</td>
<td>0.299385</td>
<td>0.362233</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.071211</td>
<td>0.292716</td>
<td>0.376440</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.061952</td>
<td>0.281709</td>
<td>0.399887</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.155731</td>
<td>0.052831</td>
<td>0.586981</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.147657</td>
<td>0.045921</td>
<td>0.641001</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.127009</td>
<td>0.043383</td>
<td>0.660838</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.130341</td>
<td>0.135900</td>
<td>0.309171</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.119079</td>
<td>0.105886</td>
<td>0.461744</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.102005</td>
<td>0.097154</td>
<td>0.506130</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.159416</td>
<td>0.036709</td>
<td>0.643722</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.147401</td>
<td>0.028988</td>
<td>0.718660</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.133312</td>
<td>0.023979</td>
<td>0.767270</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.186754</td>
<td>0.042557</td>
<td>0.596722</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.122767</td>
<td>0.023109</td>
<td>0.781009</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.114166</td>
<td>0.018596</td>
<td>0.823780</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>plt.hist(np.array(scores))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(array([1., 1., 1., 0., 1., 0., 0., 1., 0., 4.]),
 array([0.26426539, 0.31865215, 0.37303891, 0.42742567, 0.48181243,
        0.53619919, 0.59058595, 0.64497271, 0.69935947, 0.75374623,
        0.80813299]),
 &lt;BarContainer object of 10 artists&gt;)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-53-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-61" class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stratified_split(df, target, valid_size<span class="op">=</span><span class="fl">0.2</span>, test_size<span class="op">=</span><span class="fl">0.2</span>, num_bins<span class="op">=</span><span class="dv">2</span>, seed<span class="op">=</span><span class="dv">41</span>):</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    df.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    train_df, test_df <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span>test_size, </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                                        stratify<span class="op">=</span>pd.qcut(df[target], q<span class="op">=</span>num_bins, labels<span class="op">=</span><span class="va">False</span>), </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                                        random_state<span class="op">=</span>seed)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    train_df, valid_df <span class="op">=</span> train_test_split(train_df, test_size<span class="op">=</span>test_size, </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                                        stratify<span class="op">=</span>pd.qcut(train_df[target], q<span class="op">=</span>num_bins, labels<span class="op">=</span><span class="va">False</span>), </span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>                                        random_state<span class="op">=</span>seed)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_df, train_df.index, valid_df, valid_df.index, test_df, test_df.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> stratified_split(df_selected, <span class="st">'potassium_cmolkg'</span>, valid_size<span class="op">=</span><span class="fl">0.3</span>, test_size<span class="op">=</span><span class="fl">0.2</span>, num_bins<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>train_df, train_idx, valid_df, valid_idx, test_df, test_idx <span class="op">=</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check they have nothing in common</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> has_common_elements(list1, list2): <span class="cf">return</span> <span class="bu">bool</span>(<span class="bu">set</span>(list1) <span class="op">&amp;</span> <span class="bu">set</span>(list2))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>fc.test_eq(has_common_elements(train_idx, test_idx), <span class="va">False</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>fc.test_eq(has_common_elements(train_idx, valid_idx), <span class="va">False</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>fc.test_eq(has_common_elements(test_idx, valid_idx), <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AssertionError</span>                            Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[422], line 4</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Check they have nothing in common</span>
<span class="ansi-green-fg ansi-bold">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">has_common_elements</span>(list1, list2): <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">bool</span>(<span style="color:rgb(0,135,0)">set</span>(list1) <span style="color:rgb(98,98,98)">&amp;</span> <span style="color:rgb(0,135,0)">set</span>(list2))
<span class="ansi-green-fg">----&gt; 4</span> <span class="ansi-yellow-bg">fc</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">test_eq</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">has_common_elements</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">train_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">test_idx</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      5</span> fc<span style="color:rgb(98,98,98)">.</span>test_eq(has_common_elements(train_idx, valid_idx), <span style="font-weight:bold;color:rgb(0,135,0)">False</span>)
<span class="ansi-green-fg ansi-bold">      6</span> fc<span style="color:rgb(98,98,98)">.</span>test_eq(has_common_elements(test_idx, valid_idx), <span style="font-weight:bold;color:rgb(0,135,0)">False</span>)

File <span class="ansi-green-fg">~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastcore/test.py:39</span>, in <span class="ansi-cyan-fg">test_eq</span><span class="ansi-blue-fg">(a, b)</span>
<span class="ansi-green-fg ansi-bold">     37</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">test_eq</span>(a,b):
<span class="ansi-green-fg ansi-bold">     38</span>     <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">`test` that `a==b`</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">---&gt; 39</span>     <span class="ansi-yellow-bg">test</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">a</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg">b</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg">equals</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">cname</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">==</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/mambaforge/envs/uhina/lib/python3.12/site-packages/fastcore/test.py:29</span>, in <span class="ansi-cyan-fg">test</span><span class="ansi-blue-fg">(a, b, cmp, cname)</span>
<span class="ansi-green-fg ansi-bold">     27</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">`assert` that `cmp(a,b)`; display inputs and `cname or cmp.__name__` if it fails</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     28</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> cname <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>: cname<span style="color:rgb(98,98,98)">=</span>cmp<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span>
<span class="ansi-green-fg">---&gt; 29</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> cmp(a,b),<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>cname<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">:</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>a<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>b<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>

<span class="ansi-red-fg">AssertionError</span>: ==:
True
False</pre>
</div>
</div>
</div>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>train_idx, valid_idx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(Index([26, 40, 17, 67, 22, 13, 16, 41, 49, 18,  2,  9, 47, 44, 52, 63, 61, 37,
        57, 59, 66, 30, 54, 33,  7, 55, 15, 46, 19, 53, 29, 60,  4,  3, 64, 45,
        11, 20],
       dtype='int64'),
 Index([21, 58, 14, 65, 34, 56, 50, 6, 35, 62, 68, 32, 25, 24, 43, 10, 48], dtype='int64'))</code></pre>
</div>
</div>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train_df), <span class="bu">len</span>(valid_df), <span class="bu">len</span>(test_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(38, 17, 14)</code></pre>
</div>
</div>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>test_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>kssl-rt-29.png</td>
<td>0.306528</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>kssl-rt-40.png</td>
<td>0.673883</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23</td>
<td>kssl-rt-24.png</td>
<td>0.173592</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>kssl-rt-01.png</td>
<td>0.238276</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>kssl-rt-43.png</td>
<td>0.262710</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>kssl-rt-28.png</td>
<td>0.676835</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">31</td>
<td>kssl-rt-32.png</td>
<td>0.338556</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">38</td>
<td>kssl-rt-39.png</td>
<td>0.396687</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>kssl-rt-09.png</td>
<td>0.976900</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>kssl-rt-02.png</td>
<td>0.209848</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>kssl-rt-37.png</td>
<td>0.134627</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>kssl-rt-53.png</td>
<td>0.400788</td>
<td>kssl</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>kssl-rt-06.png</td>
<td>0.495470</td>
<td>kssl</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>kssl-rt-13.png</td>
<td>0.446620</td>
<td>kssl</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stratified_splitter(items): <span class="cf">return</span> [train_idx, valid_idx]</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># dblock = DataBlock(blocks=(ImageBlock, RegressionBlock),</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                    get_x=ColReader(0, pref='../../_data/ringtrial-tfm/im/'),</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                    get_y=ColReader(1),</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                    splitter=stratified_splitter,</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                    batch_tfms=[RatioResize(224)],</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                    item_tfms=[Quantize(n_valid=len(valid_idx))])</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, RegressionBlock),</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    get_x<span class="op">=</span>ColReader(<span class="dv">0</span>, pref<span class="op">=</span><span class="st">'../../_data/ringtrial-tfm/im/'</span>),</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>ColReader(<span class="dv">1</span>),</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>stratified_splitter,</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>[OrderedQuantize(n_valid<span class="op">=</span><span class="bu">len</span>(valid_idx))],</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>[</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        OrderedRatioResize(<span class="dv">224</span>),</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>        Normalize.from_stats(<span class="op">*</span>imagenet_stats)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dblock.summary(df_selected)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting-up type transforms pipelines
Collecting items from               fname  potassium_cmolkg   lab
483  kssl-rt-01.png          0.238276  kssl
484  kssl-rt-02.png          0.209848  kssl
485  kssl-rt-03.png          0.255487  kssl
486  kssl-rt-04.png          0.404965  kssl
487  kssl-rt-05.png          0.469860  kssl
488  kssl-rt-06.png          0.495470  kssl
489  kssl-rt-07.png          0.393716  kssl
490  kssl-rt-08.png          0.106628  kssl
491  kssl-rt-09.png          0.976900  kssl
492  kssl-rt-10.png          0.315519  kssl
493  kssl-rt-11.png          0.335250  kssl
494  kssl-rt-12.png          0.292252  kssl
495  kssl-rt-13.png          0.446620  kssl
496  kssl-rt-14.png          0.210804  kssl
497  kssl-rt-15.png          0.482117  kssl
498  kssl-rt-16.png          0.662054  kssl
499  kssl-rt-17.png          0.595782  kssl
500  kssl-rt-18.png          0.360761  kssl
501  kssl-rt-19.png          0.340229  kssl
502  kssl-rt-20.png          0.342816  kssl
503  kssl-rt-21.png          0.398024  kssl
504  kssl-rt-22.png          0.082409  kssl
505  kssl-rt-23.png          0.312743  kssl
506  kssl-rt-24.png          0.173592  kssl
507  kssl-rt-25.png          0.171825  kssl
508  kssl-rt-26.png          0.155182  kssl
509  kssl-rt-27.png          0.147696  kssl
510  kssl-rt-28.png          0.676835  kssl
511  kssl-rt-29.png          0.306528  kssl
512  kssl-rt-30.png          0.351649  kssl
513  kssl-rt-31.png          0.358387  kssl
514  kssl-rt-32.png          0.338556  kssl
515  kssl-rt-33.png          0.452482  kssl
516  kssl-rt-34.png          0.105971  kssl
517  kssl-rt-35.png          0.085691  kssl
518  kssl-rt-36.png          0.152824  kssl
519  kssl-rt-37.png          0.134627  kssl
520  kssl-rt-38.png          0.046282  kssl
521  kssl-rt-39.png          0.396687  kssl
522  kssl-rt-40.png          0.673883  kssl
523  kssl-rt-41.png          0.701621  kssl
524  kssl-rt-42.png          0.420853  kssl
525  kssl-rt-43.png          0.262710  kssl
526  kssl-rt-45.png          0.311652  kssl
527  kssl-rt-46.png          0.359945  kssl
528  kssl-rt-47.png          0.292476  kssl
529  kssl-rt-48.png          0.724215  kssl
530  kssl-rt-49.png          0.442131  kssl
531  kssl-rt-50.png          0.720475  kssl
532  kssl-rt-51.png          0.728205  kssl
533  kssl-rt-52.png          0.328282  kssl
534  kssl-rt-53.png          0.400788  kssl
535  kssl-rt-54.png          0.328678  kssl
536  kssl-rt-55.png          0.358884  kssl
537  kssl-rt-56.png          0.718293  kssl
538  kssl-rt-57.png          0.731367  kssl
539  kssl-rt-58.png          0.735776  kssl
540  kssl-rt-59.png          0.463199  kssl
541  kssl-rt-60.png          0.588014  kssl
542  kssl-rt-61.png          0.461032  kssl
543  kssl-rt-62.png          0.249902  kssl
544  kssl-rt-63.png          0.249902  kssl
545  kssl-rt-64.png          0.140544  kssl
546  kssl-rt-65.png          0.253882  kssl
547  kssl-rt-66.png          1.345212  kssl
548  kssl-rt-67.png          0.857869  kssl
549  kssl-rt-68.png          0.627098  kssl
550  kssl-rt-69.png          0.681596  kssl
551  kssl-rt-70.png          0.735732  kssl
Found 69 items
2 datasets of sizes 38,17
Setting up Pipeline: ColReader -- {'cols': 0, 'pref': '../../_data/ringtrial-tfm/im/', 'suff': '', 'label_delim': None} -&gt; PILBase.create
Setting up Pipeline: ColReader -- {'cols': 1, 'pref': '', 'suff': '', 'label_delim': None} -&gt; RegressionSetup -- {'c': None}

Building one sample
  Pipeline: ColReader -- {'cols': 0, 'pref': '../../_data/ringtrial-tfm/im/', 'suff': '', 'label_delim': None} -&gt; PILBase.create
    starting from
      fname               kssl-rt-27.png
potassium_cmolkg          0.147696
lab                           kssl
Name: 509, dtype: object
    applying ColReader -- {'cols': 0, 'pref': '../../_data/ringtrial-tfm/im/', 'suff': '', 'label_delim': None} gives
      ../../_data/ringtrial-tfm/im/kssl-rt-27.png
    applying PILBase.create gives
      PILImage mode=RGB size=669x221
  Pipeline: ColReader -- {'cols': 1, 'pref': '', 'suff': '', 'label_delim': None} -&gt; RegressionSetup -- {'c': None}
    starting from
      fname               kssl-rt-27.png
potassium_cmolkg          0.147696
lab                           kssl
Name: 509, dtype: object
    applying ColReader -- {'cols': 1, 'pref': '', 'suff': '', 'label_delim': None} gives
      0.14769560487272498
    applying RegressionSetup -- {'c': None} gives
      tensor(0.1477)

Final sample: (PILImage mode=RGB size=669x221, tensor(0.1477))


Collecting items from               fname  potassium_cmolkg   lab
483  kssl-rt-01.png          0.238276  kssl
484  kssl-rt-02.png          0.209848  kssl
485  kssl-rt-03.png          0.255487  kssl
486  kssl-rt-04.png          0.404965  kssl
487  kssl-rt-05.png          0.469860  kssl
488  kssl-rt-06.png          0.495470  kssl
489  kssl-rt-07.png          0.393716  kssl
490  kssl-rt-08.png          0.106628  kssl
491  kssl-rt-09.png          0.976900  kssl
492  kssl-rt-10.png          0.315519  kssl
493  kssl-rt-11.png          0.335250  kssl
494  kssl-rt-12.png          0.292252  kssl
495  kssl-rt-13.png          0.446620  kssl
496  kssl-rt-14.png          0.210804  kssl
497  kssl-rt-15.png          0.482117  kssl
498  kssl-rt-16.png          0.662054  kssl
499  kssl-rt-17.png          0.595782  kssl
500  kssl-rt-18.png          0.360761  kssl
501  kssl-rt-19.png          0.340229  kssl
502  kssl-rt-20.png          0.342816  kssl
503  kssl-rt-21.png          0.398024  kssl
504  kssl-rt-22.png          0.082409  kssl
505  kssl-rt-23.png          0.312743  kssl
506  kssl-rt-24.png          0.173592  kssl
507  kssl-rt-25.png          0.171825  kssl
508  kssl-rt-26.png          0.155182  kssl
509  kssl-rt-27.png          0.147696  kssl
510  kssl-rt-28.png          0.676835  kssl
511  kssl-rt-29.png          0.306528  kssl
512  kssl-rt-30.png          0.351649  kssl
513  kssl-rt-31.png          0.358387  kssl
514  kssl-rt-32.png          0.338556  kssl
515  kssl-rt-33.png          0.452482  kssl
516  kssl-rt-34.png          0.105971  kssl
517  kssl-rt-35.png          0.085691  kssl
518  kssl-rt-36.png          0.152824  kssl
519  kssl-rt-37.png          0.134627  kssl
520  kssl-rt-38.png          0.046282  kssl
521  kssl-rt-39.png          0.396687  kssl
522  kssl-rt-40.png          0.673883  kssl
523  kssl-rt-41.png          0.701621  kssl
524  kssl-rt-42.png          0.420853  kssl
525  kssl-rt-43.png          0.262710  kssl
526  kssl-rt-45.png          0.311652  kssl
527  kssl-rt-46.png          0.359945  kssl
528  kssl-rt-47.png          0.292476  kssl
529  kssl-rt-48.png          0.724215  kssl
530  kssl-rt-49.png          0.442131  kssl
531  kssl-rt-50.png          0.720475  kssl
532  kssl-rt-51.png          0.728205  kssl
533  kssl-rt-52.png          0.328282  kssl
534  kssl-rt-53.png          0.400788  kssl
535  kssl-rt-54.png          0.328678  kssl
536  kssl-rt-55.png          0.358884  kssl
537  kssl-rt-56.png          0.718293  kssl
538  kssl-rt-57.png          0.731367  kssl
539  kssl-rt-58.png          0.735776  kssl
540  kssl-rt-59.png          0.463199  kssl
541  kssl-rt-60.png          0.588014  kssl
542  kssl-rt-61.png          0.461032  kssl
543  kssl-rt-62.png          0.249902  kssl
544  kssl-rt-63.png          0.249902  kssl
545  kssl-rt-64.png          0.140544  kssl
546  kssl-rt-65.png          0.253882  kssl
547  kssl-rt-66.png          1.345212  kssl
548  kssl-rt-67.png          0.857869  kssl
549  kssl-rt-68.png          0.627098  kssl
550  kssl-rt-69.png          0.681596  kssl
551  kssl-rt-70.png          0.735732  kssl
Found 69 items
2 datasets of sizes 38,17
Setting up Pipeline: ColReader -- {'cols': 0, 'pref': '../../_data/ringtrial-tfm/im/', 'suff': '', 'label_delim': None} -&gt; PILBase.create
Setting up Pipeline: ColReader -- {'cols': 1, 'pref': '', 'suff': '', 'label_delim': None} -&gt; RegressionSetup -- {'c': None}
Setting up after_item: Pipeline: OrderedQuantize -- {'n_valid': 17, 'p': 1.0} -&gt; ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: OrderedRatioResize -- {'max_sz': 224, 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;)} -&gt; IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} -&gt; Normalize -- {'mean': tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]], device='mps:0'), 'std': tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]], device='mps:0'), 'axes': (0, 2, 3)}

Building one batch
Applying item_tfms to the first sample:
  Pipeline: OrderedQuantize -- {'n_valid': 17, 'p': 1.0} -&gt; ToTensor
    starting from
      (PILImage mode=RGB size=669x221, tensor(0.1477))
    applying OrderedQuantize -- {'n_valid': 17, 'p': 1.0} gives
      (PILImage mode=RGB size=669x221, tensor(0.1477))
    applying ToTensor gives
      (TensorImage of size 3x221x669, tensor(0.1477))

Adding the next 3 samples

No before_batch transform to apply

Collating items in a batch

Applying batch_tfms to the batch built
  Pipeline: OrderedRatioResize -- {'max_sz': 224, 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;)} -&gt; IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} -&gt; Normalize -- {'mean': tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]], device='mps:0'), 'std': tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]], device='mps:0'), 'axes': (0, 2, 3)}
    starting from
      (TensorImage of size 4x3x221x669, tensor([0.1477, 0.7016, 0.3608, 0.6816], device='mps:0'))
    applying OrderedRatioResize -- {'max_sz': 224, 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;)} gives
      (TensorImage of size 4x3x221x669, tensor([0.1477, 0.7016, 0.3608, 0.6816], device='mps:0'))
    applying IntToFloatTensor -- {'div': 255.0, 'div_mask': 1} gives
      (TensorImage of size 4x3x221x669, tensor([0.1477, 0.7016, 0.3608, 0.6816], device='mps:0'))
    applying Normalize -- {'mean': tensor([[[[0.4850]],

         [[0.4560]],

         [[0.4060]]]], device='mps:0'), 'std': tensor([[[[0.2290]],

         [[0.2240]],

         [[0.2250]]]], device='mps:0'), 'axes': (0, 2, 3)} gives
      (TensorImage of size 4x3x221x669, tensor([0.1477, 0.7016, 0.3608, 0.6816], device='mps:0'))</code></pre>
</div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(df_selected, bs<span class="op">=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>dls.train.n, dls.valid.n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(38, 17)</code></pre>
</div>
</div>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(nrows<span class="op">=</span><span class="dv">6</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">13</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-64-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>learn.dls <span class="op">=</span> dls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.summary()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>learn.freeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.summary()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.0014454397605732083)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-69-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, <span class="fl">1.5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">r2_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.033352</td>
<td>0.007514</td>
<td>0.877129</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>val_preds, val_targets <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.valid)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>r2_score(val_targets, val_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">InvalidParameterError</span>                     Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[131], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> val_preds, val_targets <span style="color:rgb(98,98,98)">=</span> learn<span style="color:rgb(98,98,98)">.</span>get_preds(dl<span style="color:rgb(98,98,98)">=</span>dls<span style="color:rgb(98,98,98)">.</span>valid)
<span class="ansi-green-fg">----&gt; 2</span> <span class="ansi-yellow-bg">r2_score</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val_targets</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_preds</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/mambaforge/envs/uhina/lib/python3.12/site-packages/sklearn/utils/_param_validation.py:203</span>, in <span class="ansi-cyan-fg">validate_params.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    200</span> to_ignore <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> [<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">self</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">cls</span><span style="color:rgb(175,0,0)">"</span>]
<span class="ansi-green-fg ansi-bold">    201</span> params <span style="color:rgb(98,98,98)">=</span> {k: v <span style="font-weight:bold;color:rgb(0,135,0)">for</span> k, v <span style="font-weight:bold;color:rgb(175,0,255)">in</span> params<span style="color:rgb(98,98,98)">.</span>arguments<span style="color:rgb(98,98,98)">.</span>items() <span style="font-weight:bold;color:rgb(0,135,0)">if</span> k <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> to_ignore}
<span class="ansi-green-fg">--&gt; 203</span> <span class="ansi-yellow-bg">validate_parameter_constraints</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    204</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">parameter_constraints</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">params</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">caller_name</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">func</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span style="color:rgb(0,0,135)" class="ansi-yellow-bg">__qualname__</span>
<span class="ansi-green-fg ansi-bold">    205</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    207</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">    208</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> config_context(
<span class="ansi-green-fg ansi-bold">    209</span>         skip_parameter_validation<span style="color:rgb(98,98,98)">=</span>(
<span class="ansi-green-fg ansi-bold">    210</span>             prefer_skip_nested_validation <span style="font-weight:bold;color:rgb(175,0,255)">or</span> global_skip_validation
<span class="ansi-green-fg ansi-bold">    211</span>         )
<span class="ansi-green-fg ansi-bold">    212</span>     ):

File <span class="ansi-green-fg">~/mambaforge/envs/uhina/lib/python3.12/site-packages/sklearn/utils/_param_validation.py:95</span>, in <span class="ansi-cyan-fg">validate_parameter_constraints</span><span class="ansi-blue-fg">(parameter_constraints, params, caller_name)</span>
<span class="ansi-green-fg ansi-bold">     89</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">     90</span>     constraints_str <span style="color:rgb(98,98,98)">=</span> (
<span class="ansi-green-fg ansi-bold">     91</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">, </span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(98,98,98)">.</span>join([<span style="color:rgb(0,135,0)">str</span>(c)<span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(0,135,0)">for</span><span style="color:rgb(188,188,188)"> </span>c<span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(175,0,255)">in</span><span style="color:rgb(188,188,188)"> </span>constraints[:<span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">1</span>]])<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> or</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     92</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)"> </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>constraints[<span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">1</span>]<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     93</span>     )
<span class="ansi-green-fg">---&gt; 95</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> InvalidParameterError(
<span class="ansi-green-fg ansi-bold">     96</span>     <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">The </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>param_name<span style="font-weight:bold;color:rgb(175,95,135)">!r}</span><span style="color:rgb(175,0,0)"> parameter of </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>caller_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> must be</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     97</span>     <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)"> </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>constraints_str<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">. Got </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>param_val<span style="font-weight:bold;color:rgb(175,95,135)">!r}</span><span style="color:rgb(175,0,0)"> instead.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     98</span> )

<span class="ansi-red-fg">InvalidParameterError</span>: The 'y_true' parameter of r2_score must be an array-like. Got None instead.</pre>
</div>
</div>
</div>
</section>
</section>
<section id="evaluate-fine-tuned-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-fine-tuned-model">Evaluate fine-tuned model</h3>
<div id="cell-80" class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(test_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>14</code></pre>
</div>
</div>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, RegressionBlock),</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>                   get_x<span class="op">=</span>ColReader(<span class="dv">0</span>, pref<span class="op">=</span><span class="st">'../../_data/ringtrial-tfm/im/'</span>),</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>                   get_y<span class="op">=</span>ColReader(<span class="dv">1</span>),</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>                   splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="dv">0</span>, seed<span class="op">=</span><span class="dv">41</span>),</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>                   item_tfms<span class="op">=</span>[OrderedQuantize(n_valid<span class="op">=</span><span class="bu">len</span>(test_df))],</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>                   batch_tfms<span class="op">=</span>[</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                       OrderedRatioResize(<span class="dv">224</span>),</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>                       Normalize.from_stats(<span class="op">*</span>imagenet_stats)]</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(test_df, bs<span class="op">=</span><span class="bu">len</span>(test_df))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>val_preds, val_targets <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>r2_score(val_targets, val_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.18065004067315227</code></pre>
</div>
</div>
<div id="cell-84" class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>val_preds, val_targets <span class="op">=</span> learn.tta(dl<span class="op">=</span>dls.train, n<span class="op">=</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="1" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-85" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>r2_score(val_targets, val_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.31174768615708437</code></pre>
</div>
</div>
<div id="cell-86" class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>np.c_[val_preds, val_targets]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[0.28596842, 0.33855578],
       [0.34872288, 0.30652836],
       [0.16156155, 0.1735919 ],
       [0.15021066, 0.20984755],
       [0.7913804 , 0.6738828 ],
       [0.6016631 , 0.9769003 ],
       [0.12963496, 0.23827647],
       [0.476924  , 0.3966867 ],
       [0.41498667, 0.44661984],
       [0.3885079 , 0.26271036],
       [0.4440051 , 0.49547035],
       [0.1741274 , 0.13462704],
       [0.38449523, 0.40078753],
       [0.5929916 , 0.6768349 ]], dtype=float32)</code></pre>
</div>
</div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>lab</th>
<th>lr</th>
<th>n_epochs (fine-tuning)</th>
<th>r2_score</th>
<th>n_tta</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>iaea-aug2022</td>
<td>1.5e-3</td>
<td>20</td>
<td>0.867</td>
<td>30</td>
</tr>
<tr class="even">
<td>kssl</td>
<td>1.5e-3</td>
<td>20</td>
<td>0.931</td>
<td>30</td>
</tr>
</tbody>
</table>
<!-- | kssl | 1e-3 | 5 | 0.89 | 30 |
| agrocares | 1e-3 | 20 | 0.75 | 30 |
| argonne | 1e-3 | 5 | 0.92 | 30 |

| csu-il | 1e-3 | 5 | 0.85 | 30 |
| eth-alpha-1 | 1e-3 | 30 | 0.93 | 30 |

 -->
<div id="cell-88" class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>learn.predict(<span class="st">'/Users/franckalbinet/pro/dev/uhina/_data/ringtrial-tfm/im/kssl-rt-01.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>((0.2232206165790558,), tensor([0.2232]), tensor([0.2232]))</code></pre>
</div>
</div>
<div id="cell-89" class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>np.c_[val_preds, val_targets]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[0.573713  , 0.66205376],
       [0.23120013, 0.25548682],
       [0.29060498, 0.23827647],
       [0.3890785 , 0.3588835 ],
       [0.72690636, 0.6738828 ],
       [0.52095914, 0.48211747],
       [0.5956749 , 0.6768349 ],
       [0.55163294, 0.71829337],
       [0.41514462, 0.46985987],
       [0.6461811 , 0.73577553],
       [0.3656289 , 0.24990232],
       [0.6311119 , 0.68159574],
       [0.16741446, 0.1476956 ],
       [0.3227809 , 0.31551853]], dtype=float32)</code></pre>
</div>
</div>
<div id="cell-90" class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>x, y <span class="op">=</span> val_preds, val_targets</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>plt.plot(x, y, <span class="st">'.'</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the diagonal line</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>min_val <span class="op">=</span> <span class="bu">min</span>(y.<span class="bu">min</span>(), x.<span class="bu">min</span>())</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> <span class="bu">max</span>(y.<span class="bu">max</span>(), x.<span class="bu">max</span>())</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>plt.plot([min_val, max_val], [min_val, max_val], <span class="st">'k--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-81-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="on-single-images" class="level3">
<h3 class="anchored" data-anchor-id="on-single-images">On single images</h3>
<div id="cell-93" class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_with_transforms(learn, img_path, n_predictions<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the image</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> PILImage.create(img_path)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create instances of the transforms</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    ratio_resize <span class="op">=</span> RatioResize(<span class="dv">224</span>)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    quantize <span class="op">=</span> Quantize()</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> []</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_predictions):</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply transforms</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>        img_resized <span class="op">=</span> ratio_resize(img)</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>        img_quantized <span class="op">=</span> quantize(img_resized)</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predict</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>        pred, _, _ <span class="op">=</span> learn.predict(img_quantized)</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>        predictions.append(pred[<span class="dv">0</span>])</span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> statistics <span class="im">import</span> mode</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate mean and standard deviation</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>    mean_pred <span class="op">=</span> np.mean(predictions)</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>    std_pred <span class="op">=</span> np.std(predictions)</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>    median_pred <span class="op">=</span> np.median(predictions)</span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>    mode_pred <span class="op">=</span> mode(predictions)</span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_pred, std_pred, median_pred, mode_pred, predictions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-94" class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>test_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">potassium_cmolkg</th>
<th data-quarto-table-cell-role="th">lab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">416</td>
<td>iaea-aug2022-rt-03.png</td>
<td>0.255487</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">453</td>
<td>iaea-aug2022-rt-40.png</td>
<td>0.673883</td>
<td>iaea-aug2022</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">414</td>
<td>iaea-aug2022-rt-01.png</td>
<td>0.238276</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">441</td>
<td>iaea-aug2022-rt-28.png</td>
<td>0.676835</td>
<td>iaea-aug2022</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">470</td>
<td>iaea-aug2022-rt-58.png</td>
<td>0.735776</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">423</td>
<td>iaea-aug2022-rt-10.png</td>
<td>0.315519</td>
<td>iaea-aug2022</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">429</td>
<td>iaea-aug2022-rt-16.png</td>
<td>0.662054</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">468</td>
<td>iaea-aug2022-rt-56.png</td>
<td>0.718293</td>
<td>iaea-aug2022</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">428</td>
<td>iaea-aug2022-rt-15.png</td>
<td>0.482117</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">467</td>
<td>iaea-aug2022-rt-55.png</td>
<td>0.358884</td>
<td>iaea-aug2022</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">481</td>
<td>iaea-aug2022-rt-69.png</td>
<td>0.681596</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">440</td>
<td>iaea-aug2022-rt-27.png</td>
<td>0.147696</td>
<td>iaea-aug2022</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">475</td>
<td>iaea-aug2022-rt-63.png</td>
<td>0.249902</td>
<td>iaea-aug2022</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">418</td>
<td>iaea-aug2022-rt-05.png</td>
<td>0.469860</td>
<td>iaea-aug2022</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-95" class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>learn.predict(<span class="st">'/Users/franckalbinet/pro/dev/uhina/_data/ringtrial-tfm/im/iaea-aug2022-rt-03.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>((0.22924283146858215,), tensor([0.2292]), tensor([0.2292]))</code></pre>
</div>
</div>
<div id="cell-96" class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_with_tta_histogram(learn, img_path, n_tta<span class="op">=</span><span class="dv">40</span>):</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the image</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> PILImage.create(img_path)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a test DataLoader with a single image</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    test_dl <span class="op">=</span> learn.dls.test_dl([img])</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Collect predictions</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    all_preds <span class="op">=</span> []</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_tta):</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get prediction with TTA (n=1 for a single augmentation each time)</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>        preds, _ <span class="op">=</span> learn.tta(dl<span class="op">=</span>test_dl, n<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>        all_preds.append(preds[<span class="dv">0</span>][<span class="dv">0</span>].item())  <span class="co"># Assuming single output</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    all_preds <span class="op">=</span> np.array(all_preds)</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate statistics</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>    mean_pred <span class="op">=</span> np.mean(all_preds)</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>    std_pred <span class="op">=</span> np.std(all_preds)</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>    median_pred <span class="op">=</span> np.median(all_preds)</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_pred, std_pred, median_pred, all_preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-97" class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> <span class="st">'iaea-aug2022-rt-03.png'</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>img_path <span class="op">=</span> Path(<span class="st">'/Users/franckalbinet/pro/dev/uhina/_data/ringtrial-tfm/im/'</span>) <span class="op">/</span> fname</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>mean, std, median, all_preds <span class="op">=</span> predict_with_tta_histogram(learn, img_path, n_tta<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean prediction: </span><span class="sc">{</span>mean<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Standard deviation: </span><span class="sc">{</span>std<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Median prediction: </span><span class="sc">{</span>median<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"All predictions: </span><span class="sc">{</span>all_preds<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to compare with the ground truth</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Ground truth:'</span>, df[df.fname <span class="op">==</span> fname][<span class="st">'potassium_cmolkg'</span>].values[<span class="dv">0</span>])</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>plt.hist(all_preds, bins<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Histogram of TTA Predictions'</span>)</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Predicted Value'</span>)</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="20" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean prediction: 0.2245
Standard deviation: 0.0293
Median prediction: 0.2370
All predictions: [0.2538105  0.20756826 0.16517167 0.18890977 0.23950726 0.25089669
 0.23727572 0.1606092  0.23708239 0.24203241 0.24409012 0.23063052
 0.22467479 0.22609089 0.21201754 0.24700734 0.24322104 0.1814348
 0.23694187 0.21401702 0.24518737 0.23962407 0.24665055 0.23783752
 0.23432088 0.13502732 0.24622732 0.22676304 0.24990481 0.23013265]
Ground truth: 0.29109</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-87-output-122.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-98" class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>plt.plot(all_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-99" class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Canonical fine-tuning</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from fastai.vision.all import *</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load the pretrained model</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = load_learner('./models/650-4000-epoch-25-lr-3e-3.pkl', cpu=False)</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # Prepare your new data</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="co"># path = 'path/to/your/data'</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="co"># dls = ImageDataLoaders.from_folder(path, valid_pct=0.2, item_tfms=Resize(224), batch_tfms=aug_transforms())</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Set the new data</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.dls = dls</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Fine-tune the head of the model</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.freeze()</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # alternatively: learn.freeze_to(n)</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.lr_find()</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit_one_cycle(5, 3e-3)</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # Fine-tune the entire model</span></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.unfreeze()</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.lr_find()</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit_one_cycle(5, slice(1e-5, 1e-3))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-100" class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = vision_learner(dls, resnet18, pretrained=False, metrics=R2Score()).to_fp16()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-101" class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.lr_find()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-102" class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.lr_find()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.002511886414140463)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-92-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-103" class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit_one_cycle(5, 3e-3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluation" class="level2">
<h2 class="anchored" data-anchor-id="evaluation">Evaluation</h2>
<div id="cell-105" class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert predictions and targets to numpy arrays</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assess_model(val_preds, val_targets):</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    val_preds <span class="op">=</span> val_preds.numpy().flatten()</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    val_targets <span class="op">=</span> val_targets.numpy()</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a DataFrame with the results</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Predicted'</span>: val_preds,</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: val_targets</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the first few rows of the results</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(results_df.head())</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and print the R2 score</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(val_targets, val_preds)</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"R2 Score on validation set: </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-106" class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>dls.train.n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>69</code></pre>
</div>
</div>
<div id="cell-107" class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>val_preds, val_targets <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.train)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>assess_model(val_preds, val_targets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Predicted    Actual
0   0.046272  0.210804
1   0.528189  0.976900
2   0.465372  0.469860
3   0.258100  0.338556
4   0.112802  0.147696
R2 Score on validation set: 0.7392</code></pre>
</div>
</div>
<div id="cell-108" class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>val_preds, val_targets <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>dls.train)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(val_targets, val_preds)<span class="op">;</span> r2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-109" class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(val_targets, val_preds)<span class="op">;</span> r2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.7391959435205914</code></pre>
</div>
</div>
<div id="cell-111" class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> []</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">20</span>):</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    val_preds, val_targets <span class="op">=</span> learn.tta(dl<span class="op">=</span>dls.train, n<span class="op">=</span>n)</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    scores.append(r2_score(val_targets, val_preds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="25" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div id="cell-112" class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">20</span>))</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>plt.plot(x, scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-101-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-113" class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EXAMPLE of TTA on single item</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from fastai.vision.all import *</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Define your TTA transforms</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="co"># tta_tfms = [</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     RandomResizedCrop(224, min_scale=0.5),</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     Flip(),</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     Rotate(degrees=(-15, 15)),</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     Brightness(max_lighting=0.2),</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     Contrast(max_lighting=0.2)</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ]</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a><span class="co"># # Create a pipeline of TTA transformations</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a><span class="co"># tta_pipeline = Pipeline(tta_tfms)</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load your model</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = load_learner('path/to/your/model.pkl')</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a><span class="co"># # Define the input data (e.g., an image)</span></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a><span class="co"># input_data = PILImage.create('path/to/your/image.jpg')</span></span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a><span class="co"># # Apply TTA transforms to the input data and make predictions</span></span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a><span class="co"># predictions = []</span></span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a><span class="co"># for _ in range(5):  # Apply 5 different augmentations</span></span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     augmented_data = tta_pipeline(input_data)</span></span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     prediction = learn.predict(augmented_data)</span></span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     predictions.append(prediction)</span></span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a><span class="co"># # Average the predictions</span></span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a><span class="co"># average_prediction = sum(predictions) / len(predictions)</span></span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a><span class="co"># print(average_prediction)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-114" class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming you have a new CSV file for your test data</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co"># test_source = '../../_data/ossl-tfm/ossl-tfm-test.csv'</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="co"># test_df = pd.read_csv(test_source)</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Create a new DataLoader for the test data</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="co"># test_dl = learn.dls.test_dl(test_df)</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get predictions on the test set</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a><span class="co"># test_preds, test_targets = learn.get_preds(dl=test_dl)</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Now you can use test_preds and test_targets for further analysis</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-115" class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>assess_model(val_preds, val_targets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Predicted    Actual
0   0.312483  0.000000
1   0.126990  0.184960
2   0.365726  0.194201
3   0.239089  0.262364
4   0.402980  0.355799
R2 Score on validation set: 0.8325</code></pre>
</div>
</div>
<div id="cell-116" class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>assess_model(val_preds_tta, val_targets_tta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Predicted    Actual
0   0.246857  0.000000
1   0.148590  0.184960
2   0.371643  0.194201
3   0.226535  0.262364
4   0.407333  0.355799
R2 Score on validation set: 0.8378</code></pre>
</div>
</div>
<div id="cell-117" class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>val_preds_np <span class="op">=</span> val_preds</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>val_targets_np <span class="op">=</span> val_targets</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the transformation: exp(y) - 1</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>val_preds_transformed <span class="op">=</span> np.exp(val_preds_np) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>val_targets_transformed <span class="op">=</span> np.exp(val_targets_np) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with the results</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Predicted'</span>: val_preds_transformed,</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Actual'</span>: val_targets_transformed</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the results</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_df.head())</span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and print the R2 score</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(val_targets_transformed, val_preds_transformed)</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"R2 Score on validation set (after transformation): </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and print the MAPE, handling zero values</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mean_absolute_percentage_error(y_true, y_pred):</span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>    non_zero <span class="op">=</span> (y_true <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(np.<span class="bu">abs</span>((y_true[non_zero] <span class="op">-</span> y_pred[non_zero]) <span class="op">/</span> y_true[non_zero])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>mape <span class="op">=</span> mean_absolute_percentage_error(val_targets_transformed, val_preds_transformed)</span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean Absolute Percentage Error (MAPE) on validation set: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and print the MAE as an alternative metric</span></span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(val_targets_transformed, val_preds_transformed)</span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean Absolute Error (MAE) on validation set: </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Predicted   Actual
0   0.366814  0.00000
1   0.135405  0.20317
2   0.441560  0.21434
3   0.270092  0.30000
4   0.496277  0.42732
R2 Score on validation set (after transformation): 0.6936
Mean Absolute Percentage Error (MAPE) on validation set: 50.72%
Mean Absolute Error (MAE) on validation set: 0.1956</code></pre>
</div>
</div>
<div id="cell-118" class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use logarithmic bins for the colormap</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> plt.hexbin(val_targets, val_preds, gridsize<span class="op">=</span><span class="dv">65</span>, </span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>               bins<span class="op">=</span><span class="st">'log'</span>, cmap<span class="op">=</span><span class="st">'Spectral_r'</span>, mincnt<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>               alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the actual min and max counts from the hexbin data</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> h.get_array()</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>min_count <span class="op">=</span> counts[counts <span class="op">&gt;</span> <span class="dv">0</span>].<span class="bu">min</span>()  <span class="co"># Minimum non-zero count</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>max_count <span class="op">=</span> counts.<span class="bu">max</span>()</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a logarithmic colorbar</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>cb <span class="op">=</span> plt.colorbar(h, label<span class="op">=</span><span class="st">'Count in bin'</span>, shrink<span class="op">=</span><span class="fl">0.73</span>)</span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>tick_locations <span class="op">=</span> np.logspace(np.log10(min_count), np.log10(max_count), <span class="dv">5</span>)</span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>cb.set_ticks(tick_locations)</span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>cb.set_ticklabels([<span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> x <span class="kw">in</span> tick_locations])</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the diagonal line</span></span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>min_val <span class="op">=</span> <span class="bu">min</span>(val_targets.<span class="bu">min</span>(), val_preds.<span class="bu">min</span>())</span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>max_val <span class="op">=</span> <span class="bu">max</span>(val_targets.<span class="bu">max</span>(), val_preds.<span class="bu">max</span>())</span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>plt.plot([min_val, max_val], [min_val, max_val], <span class="st">'k--'</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Actual Values'</span>)</span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Predicted Values'</span>)</span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Predicted vs Actual Values (Hexbin with Log Scale)'</span>)</span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add grid lines</span></span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.65</span>)</span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the same limits for both axes</span></span>
<span id="cb143-33"><a href="#cb143-33" aria-hidden="true" tabindex="-1"></a>plt.xlim(min_val, max_val)</span>
<span id="cb143-34"><a href="#cb143-34" aria-hidden="true" tabindex="-1"></a>plt.ylim(min_val, max_val)</span>
<span id="cb143-35"><a href="#cb143-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-36"><a href="#cb143-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the plot square</span></span>
<span id="cb143-37"><a href="#cb143-37" aria-hidden="true" tabindex="-1"></a>plt.gca().set_aspect(<span class="st">'equal'</span>, adjustable<span class="op">=</span><span class="st">'box'</span>)</span>
<span id="cb143-38"><a href="#cb143-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-39"><a href="#cb143-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb143-40"><a href="#cb143-40" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb143-41"><a href="#cb143-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-42"><a href="#cb143-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the range of counts in the hexbins</span></span>
<span id="cb143-43"><a href="#cb143-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Min non-zero count in hexbins: </span><span class="sc">{</span>min_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb143-44"><a href="#cb143-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Max count in hexbins: </span><span class="sc">{</span>max_count<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ringtrial_files/figure-html/cell-107-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Min non-zero count in hexbins: 1.0
Max count in hexbins: 157.0</code></pre>
</div>
</div>
<div id="cell-119" class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>path_model <span class="op">=</span> Path(<span class="st">'./models'</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>learn.export(path_model <span class="op">/</span> <span class="st">'0.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<div id="cell-121" class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>ossl_source <span class="op">=</span> Path(<span class="st">'../../_data/ossl-tfm/img'</span>)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>learn.predict(ossl_source <span class="op">/</span> <span class="st">'0a0a0c647671fd3030cc13ba5432eb88.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>((0.5229991674423218,), tensor([0.5230]), tensor([0.5230]))</code></pre>
</div>
</div>
<div id="cell-122" class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>df[df[<span class="st">'fname'</span>] <span class="op">==</span> <span class="st">'0a0a0c647671fd3030cc13ba5432eb88.png'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">kex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">28867</td>
<td>0a0a0c647671fd3030cc13ba5432eb88.png</td>
<td>0.525379</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-123" class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>np.exp(<span class="dv">3</span>) <span class="op">-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>19.085536923187668</code></pre>
</div>
</div>
</section>
<section id="experiments" class="level2">
<h2 class="anchored" data-anchor-id="experiments">Experiments:</h2>
<p>Color scale: <code>viridis</code> | Discretization: <code>percentiles = [i for i in range(60, 100)]</code></p>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 15%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>with axis ticks</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>100</td>
<td>1e-3</td>
<td>10</td>
<td>0.648</td>
<td>05:12</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.69</td>
<td>07:30</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>ResNet-18</td>
<td>750 (original size)</td>
<td>1e-3</td>
<td>10</td>
<td>0.71</td>
<td>36:00</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>20</td>
<td>0.704</td>
<td>07:30</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.71</td>
<td>07:00</td>
<td>No</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>Discretization: <code>percentiles = [i for i in range(20, 100)]</code></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>with axis ticks</th>
<th>colour scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.7</td>
<td>05:12</td>
<td>No</td>
<td>No</td>
<td><code>viridis</code></td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>3e-3</td>
<td>10</td>
<td>0.71</td>
<td>05:12</td>
<td>No</td>
<td>No</td>
<td><code>jet</code></td>
</tr>
</tbody>
</table>
<p>From now on <code>with axis ticks</code> is always <code>No</code>.</p>
<p>Discretization: esimated on <code>10000</code> cwt power percentiles <code>[20, 30, 40, 50, 60, 70, 80, 90, 95, 97, 99]</code></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>remark</th>
<th>colour scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.71</td>
<td>05:12</td>
<td>No</td>
<td>None</td>
<td><code>jet</code></td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.685</td>
<td>05:12</td>
<td>No</td>
<td>y range added</td>
<td><code>jet</code></td>
</tr>
</tbody>
</table>
<p>From now on random splitter with <code>10%</code> validation and random seed <code>41</code>.</p>
<p>Discretization: esimated on <code>10000</code> cwt power percentiles <code>[20, 30, 40, 50, 60, 70, 80, 90, 95, 97, 99]</code></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Image Size</th>
<th>Learning Rate</th>
<th>Epochs</th>
<th>R2 Score</th>
<th>Time per Epoch</th>
<th>Finetuning</th>
<th>remark</th>
<th>colour scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.7</td>
<td>05:12</td>
<td>No</td>
<td>Pre-train &amp; normalize: True</td>
<td><code>jet</code></td>
</tr>
<tr class="even">
<td>ResNet-18</td>
<td>224</td>
<td>2e-3</td>
<td>10</td>
<td>0.796</td>
<td>08:12</td>
<td>No</td>
<td>No Pre-train</td>
<td><code>jet</code></td>
</tr>
<tr class="odd">
<td>ResNet-18</td>
<td>224</td>
<td>3e-3</td>
<td>10</td>
<td>0.7</td>
<td>05:12</td>
<td>No</td>
<td>Pre-train &amp; normalize: False</td>
<td><code>jet</code></td>
</tr>
<tr class="even">
<td>ResNet-18 (id=0)</td>
<td>224</td>
<td>2e-3</td>
<td>20</td>
<td><strong>0.829</strong></td>
<td>08:12</td>
<td>No</td>
<td>No Pre-train (try 18 epochs)</td>
<td><code>jet</code></td>
</tr>
</tbody>
</table>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/franckalbinet\.github\.io\/uhina");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/franckalbinet/uhina/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>